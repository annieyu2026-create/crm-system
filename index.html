```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客户管理系统</title>
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.6.0/echarts.min.js"></script>
    <style>
        * { font-family: 'Noto Sans SC', sans-serif; }
        body { background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%); }
        .glass-effect { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s ease; }
        .btn-primary:hover { transform: scale(1.05); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4); }
        .sidebar-link { transition: all 0.3s ease; position: relative; overflow: hidden; }
        .sidebar-link::before { content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 3px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transform: scaleY(0); transition: transform 0.3s ease; }
        .sidebar-link:hover::before, .sidebar-link.active::before { transform: scaleY(1); }
        .sidebar-link.active { background: linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, transparent 100%); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; animation: fadeIn 0.3s ease; }
        .modal.active { display: flex; justify-content: center; align-items: center; }
        .modal-content { animation: slideUp 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .search-input { transition: all 0.3s ease; }
        .search-input:focus { box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2); }
        .table-row { transition: all 0.2s ease; }
        .table-row:hover { background: rgba(102, 126, 234, 0.05); transform: scale(1.01); }
    </style>
</head>
<body class="min-h-screen">
    <!-- 登录/注册页面 -->
    <div id="auth-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl p-8 max-w-md w-full shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto rounded-2xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center mb-4">
                    <i class="fas fa-users text-white text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">客户管理系统</h1>
                <p class="text-gray-500">CRM System</p>
            </div>
            
            <!-- 登录表单 -->
            <div id="login-form-container">
                <h2 class="text-xl font-bold text-gray-800 mb-6">登录账号</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">邮箱账号</label>
                        <input type="email" id="login-email" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="请输入企业邮箱 @fengfancloud.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">密码</label>
                        <input type="password" id="login-password" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="请输入密码">
                    </div>
                    <button type="submit" class="w-full btn-primary text-white px-6 py-3 rounded-xl font-medium shadow-lg">登录</button>
                </form>
                <p class="text-center text-gray-500 text-sm mt-4">还没有账号？<a href="#" id="show-register" class="text-purple-600 hover:text-purple-700 font-medium">立即注册</a></p>
            </div>
            
            <!-- 注册表单 -->
            <div id="register-form-container" class="hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-6">注册账号</h2>
                <form id="register-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">姓名</label>
                        <input type="text" id="register-name" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="请输入姓名">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">邮箱账号</label>
                        <input type="email" id="register-email" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="请输入企业邮箱 @fengfancloud.com">
                        <p class="text-xs text-gray-500 mt-1">仅支持公司企业邮箱注册</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">密码</label>
                        <input type="password" id="register-password" required minlength="6" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="至少6位密码">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">确认密码</label>
                        <input type="password" id="register-password-confirm" required minlength="6" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="请再次输入密码">
                    </div>
                    <button type="submit" class="w-full btn-primary text-white px-6 py-3 rounded-xl font-medium shadow-lg">注册</button>
                </form>
                <p class="text-center text-gray-500 text-sm mt-4">已有账号？<a href="#" id="show-login" class="text-purple-600 hover:text-purple-700 font-medium">立即登录</a></p>
            </div>
        </div>
    </div>

    <!-- 主系统界面 -->
    <div id="main-system" class="hidden flex min-h-screen">
        <!-- 侧边栏 -->
        <div class="w-64 glass-effect border-r border-gray-200 flex flex-col fixed h-full z-10">
            <div class="p-8">
                <div class="flex items-center space-x-3 mb-8">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center shadow-lg">
                        <i class="fas fa-chart-pie text-white"></i>
                    </div>
                    <span class="text-xl font-bold text-gray-800">CRM系统</span>
                </div>
                <nav class="space-y-2">
                    <a href="#" id="nav-dashboard" class="sidebar-link active flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-600 hover:text-purple-600"><i class="fas fa-home w-6"></i><span>数据概览</span></a>
                    <a href="#" id="nav-customers" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-600 hover:text-purple-600"><i class="fas fa-users w-6"></i><span>客户列表</span></a>
                    <a href="#" id="nav-opportunities" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-600 hover:text-purple-600"><i class="fas fa-briefcase w-6"></i><span>商机管理</span></a>
                    <a href="#" id="nav-interactions" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-600 hover:text-purple-600"><i class="fas fa-comments w-6"></i><span>交互记录</span></a>
                    <a href="#" id="nav-analysis" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-600 hover:text-purple-600"><i class="fas fa-chart-line w-6"></i><span>数据分析</span></a>
                </nav>
            </div>
            <div class="mt-auto p-8 border-t border-gray-100">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center"><i class="fas fa-user text-gray-500"></i></div>
                    <div><p class="font-medium text-gray-800" id="user-name">未登录</p><p class="text-xs text-gray-500" id="user-role">游客</p></div>
                </div>
                <button id="logout-btn" class="w-full flex items-center justify-center space-x-2 px-4 py-2 border border-gray-200 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors"><i class="fas fa-sign-out-alt"></i><span>退出登录</span></button>
            </div>
        </div>

        <!-- 主内容区域 -->
        <div class="flex-1 ml-64 p-8">
            <div class="flex justify-between items-center mb-8">
                <div><h2 class="text-2xl font-bold text-gray-800" id="page-title">数据概览</h2><p class="text-gray-500 mt-1" id="current-date">2026年2月12日</p></div>
                <div class="flex items-center space-x-4">
                    <div class="relative"><i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i><input type="text" placeholder="全局搜索..." class="search-input pl-12 pr-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500 w-64"></div>
                    <button class="w-10 h-10 rounded-xl bg-white border border-gray-200 flex items-center justify-center text-gray-500 hover:text-purple-600 transition-colors relative"><i class="fas fa-bell"></i><span class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></span></button>
                </div>
            </div>

            <div id="content-area">
                <!-- 仪表盘内容 -->
                <div id="dashboard-view" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="glass-effect p-6 rounded-2xl card-hover">
                            <div class="flex justify-between items-start mb-4"><div><p class="text-gray-500 text-sm">总客户数</p><h3 class="text-3xl font-bold text-gray-800 mt-1" id="stat-total-customers">0</h3></div><div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center"><i class="fas fa-users text-blue-500"></i></div></div>
                            <div class="flex items-center text-sm text-green-500"><i class="fas fa-arrow-up mr-1"></i><span>较上月 +12%</span></div>
                        </div>
                        <div class="glass-effect p-6 rounded-2xl card-hover">
                            <div class="flex justify-between items-start mb-4"><div><p class="text-gray-500 text-sm">活跃客户</p><h3 class="text-3xl font-bold text-gray-800 mt-1" id="stat-active-customers">0</h3></div><div class="w-10 h-10 rounded-lg bg-green-50 flex items-center justify-center"><i class="fas fa-user-check text-green-500"></i></div></div>
                            <div class="flex items-center text-sm text-green-500"><i class="fas fa-arrow-up mr-1"></i><span>较上月 +5%</span></div>
                        </div>
                        <div class="glass-effect p-6 rounded-2xl card-hover">
                            <div class="flex justify-between items-start mb-4"><div><p class="text-gray-500 text-sm">本月交互</p><h3 class="text-3xl font-bold text-gray-800 mt-1" id="stat-interactions">0</h3></div><div class="w-10 h-10 rounded-lg bg-purple-50 flex items-center justify-center"><i class="fas fa-comments text-purple-500"></i></div></div>
                            <div class="flex items-center text-sm text-purple-500"><i class="fas fa-arrow-up mr-1"></i><span>较上月 +8%</span></div>
                        </div>
                        <div class="glass-effect p-6 rounded-2xl card-hover">
                            <div class="flex justify-between items-start mb-4"><div><p class="text-gray-500 text-sm">总成交额</p><h3 class="text-3xl font-bold text-gray-800 mt-1" id="stat-revenue">¥0</h3></div><div class="w-10 h-10 rounded-lg bg-orange-50 flex items-center justify-center"><i class="fas fa-yen-sign text-orange-500"></i></div></div>
                            <div class="flex items-center text-sm text-orange-500"><i class="fas fa-arrow-up mr-1"></i><span>较上月 +15%</span></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="glass-effect p-6 rounded-2xl col-span-2"><h3 class="text-lg font-bold text-gray-800 mb-4">客户增长趋势</h3><div id="chart-growth" style="height: 300px;"></div></div>
                        <div class="glass-effect p-6 rounded-2xl"><h3 class="text-lg font-bold text-gray-800 mb-4">客户来源分布</h3><div id="chart-source" style="height: 300px;"></div></div>
                    </div>
                </div>

                <!-- 客户列表视图 -->
                <div id="customers-view" class="hidden space-y-6">
                    <div class="glass-effect p-6 rounded-2xl">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex space-x-4">
                                <div class="relative"><i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i><input type="text" id="customer-search" placeholder="搜索客户..." class="search-input pl-12 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500"></div>
                                <select id="customer-filter-status" class="px-4 py-2 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500"><option value="all">所有状态</option><option value="active">活跃</option><option value="potential">潜在</option><option value="inactive">休眠</option></select>
                            </div>
                            <button id="add-customer-btn" class="btn-primary text-white px-6 py-2 rounded-xl font-medium shadow-lg flex items-center space-x-2"><i class="fas fa-plus"></i><span>添加客户</span></button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead><tr class="text-left border-b border-gray-100"><th class="pb-4 font-semibold text-gray-600 pl-4">客户名称</th><th class="pb py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">公司名称 *</label><input type="text" id="opportunity-company" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">联系邮箱 *</label><input type="email" id="opportunity-email" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">联系电话 *</label><input type="tel" id="opportunity-phone" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">产品名称 *</label><input type="text" id="opportunity-product" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="例如：企业管理软件"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">产品报价 (元) *</label><input type="number" id="opportunity-original-price" required min="0" step="0.01" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="0.00"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">折扣 (%)</label><input type="number" id="opportunity-discount" min="0" max="100" step="0.1" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="例如：10 表示9折" value="0"><p class="text-xs text-gray-500 mt-1">0表示无折扣，10表示9折，20表示8折</p></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">合同金额 (元) *</label><input type="number" id="opportunity-amount" required min="0" step="0.01" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500 bg-gray-50" placeholder="0.00" readonly><p class="text-xs text-gray-500 mt-1">根据报价和折扣自动计算</p></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">交付周期 (天) *</label><input type="number" id="opportunity-delivery-period" required min="1" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="例如：30"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">回款周期 (天) *</label><input type="number" id="opportunity-payment-period" required min="1" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="例如：60"></div>
                </div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">是否已交付</label><div class="flex items-center space-x-6"><label class="flex items-center cursor-pointer"><input type="radio" name="delivery-status" value="false" checked class="w-4 h-4 text-purple-600 focus:ring-purple-500"><span class="ml-2 text-gray-700">未交付</span></label><label class="flex items-center cursor-pointer"><input type="radio" name="delivery-status" value="true" class="w-4 h-4 text-purple-600 focus:ring-purple-500"><span class="ml-2 text-gray-700">已交付</span></label></div></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">备注</label><textarea id="opportunity-notes" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="商机相关说明..."></textarea></div>
                <div class="flex justify-end space-x-4 pt-4"><button type="button" class="close-modal px-6 py-3 border border-gray-300 rounded-xl text-gray-700 hover:bg-gray-50 font-medium">取消</button><button type="submit" class="btn-primary text-white px-6 py-3 rounded-xl font-medium shadow-lg">保存</button></div>
            </form>
        </div>
    </div>

    ```html
    <script>
        // ==================== 核心数据存储 ====================
        let currentUser = null; // 当前登录用户
        let users = []; // 用户列表
        let customers = [];
        let interactions = [];
        let opportunities = [];
        let currentEditId = null;
        let currentEditType = null; // 'customer' or 'opportunity'

        // ==================== 初始化与数据加载 ====================
        function initializeData() {
            // 1. 初始化用户
            const savedUsers = localStorage.getItem('users');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            } else {
                users = [{
                    id: 1,
                    name: '系统管理员',
                    email: 'admin@fengfancloud.com',
                    password: 'admin123',
                    role: 'admin',
                    createdAt: '2026-01-01'
                }];
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            // 2. 检查登录状态
            const savedCurrentUser = localStorage.getItem('currentUser');
            if (savedCurrentUser) {
                currentUser = JSON.parse(savedCurrentUser);
                showMainSystem();
            } else {
                showAuthPage();
                // 如果未登录，直接返回，不加载业务数据
                return; 
            }
            
            // 3. 加载业务数据
            const savedCustomers = localStorage.getItem('customers');
            const savedInteractions = localStorage.getItem('interactions');
            const savedOpportunities = localStorage.getItem('opportunities');
            
            if (savedCustomers) { customers = JSON.parse(savedCustomers); }
            else { 
                // 写入默认客户数据
                customers = [
                    { id: 1, name: '张明', company: '科技创新有限公司', email: 'zhangming@tech.com', phone: '13800138001', source: '网站', status: 'active', salesOwners: '王经理', interestedProducts: 'CRM系统', notes: '重要客户', createdAt: '2026-01-15', value: 150000, createdBy: 1 },
                    { id: 2, name: '李娜', company: '华夏贸易集团', email: 'lina@huaxia.com', phone: '13800138002', source: '推荐', status: 'active', salesOwners: '张总监', interestedProducts: '数据分析', notes: '老客户介绍', createdAt: '2026-01-20', value: 280000, createdBy: 1 }
                ];
                saveData(); 
            }
            
            if (savedInteractions) { interactions = JSON.parse(savedInteractions); }
            else { interactions = []; saveData(); }
            
            if (savedOpportunities) { opportunities = JSON.parse(savedOpportunities); }
            else { opportunities = []; saveData(); }
        }

        // 保存数据到localStorage
        function saveData() {
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('customers', JSON.stringify(customers));
            localStorage.setItem('interactions', JSON.stringify(interactions));
            localStorage.setItem('opportunities', JSON.stringify(opportunities));
        }

        // ==================== 用户认证功能 ====================
        const COMPANY_EMAIL_DOMAIN = '@fengfancloud.com';

        function isValidCompanyEmail(email) {
            return email.toLowerCase().endsWith(COMPANY_EMAIL_DOMAIN.toLowerCase());
        }

        function showAuthPage() {
            document.getElementById('auth-page').classList.remove('hidden');
            document.getElementById('main-system').classList.add('hidden');
        }

        function showMainSystem() {
            document.getElementById('auth-page').classList.add('hidden');
            document.getElementById('main-system').classList.remove('hidden');
            updateUserInfo();
        }

        function updateUserInfo() {
            if (!currentUser) return;
            document.getElementById('current-user-name').textContent = currentUser.name;
            document.getElementById('current-user-email').textContent = currentUser.email;
            
            const roleBadge = document.getElementById('current-user-role-badge');
            if (currentUser.role === 'admin') {
                roleBadge.innerHTML = '<i class="fas fa-user-shield mr-1"></i>管理员';
                roleBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700';
            } else {
                roleBadge.innerHTML = '<i class="fas fa-user mr-1"></i>普通用户';
                roleBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700';
            }
        }

        function initAuthForms() {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showRegisterBtn = document.getElementById('show-register');
            const showLoginBtn = document.getElementById('show-login');
            const logoutBtn = document.getElementById('logout-btn');
            
            showRegisterBtn.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('login-form-container').classList.add('hidden');
                document.getElementById('register-form-container').classList.remove('hidden');
            });
            
            showLoginBtn.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('register-form-container').classList.add('hidden');
                document.getElementById('login-form-container').classList.remove('hidden');
            });
            
            // 登录逻辑
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                if (!isValidCompanyEmail(email)) {
                    alert(`请使用公司企业邮箱（${COMPANY_EMAIL_DOMAIN}）登录！`);
                    return;
                }
                
                // 重新读取最新用户数据
                const currentUsers = JSON.parse(localStorage.getItem('users') || '[]');
                const user = currentUsers.find(u => u.email === email && u.password === password);
                
                if (user) {
                    currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showMainSystem();
                    initializeData();
                    updateDashboard();
                    renderCustomers();
                } else {
                    alert('邮箱或密码错误！(如果您刚注册，请确认邮箱拼写)');
                }
            });
            
            // 注册逻辑
            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-password-confirm').value;
                
                if (!isValidCompanyEmail(email)) {
                    alert(`请使用公司企业邮箱（${COMPANY_EMAIL_DOMAIN}）注册！`);
                    return;
                }
                if (password !== confirmPassword) {
                    alert('两次输入的密码不一致！');
                    return;
                }
                
                // 重新读取最新用户列表防止覆盖
                users = JSON.parse(localStorage.getItem('users') || '[]');
                
                if (users.find(u => u.email === email)) {
                    alert('该邮箱已被注册！');
                    return;
                }
                
                const newUser = {
                    id: Date.now(),
                    name: name,
                    email: email,
                    password: password,
                    role: 'user',
                    createdAt: new Date().toISOString().split('T')[0]
                };
                
                users.push(newUser);
                localStorage.setItem('users', JSON.stringify(users)); // 立即保存
                
                alert('注册成功！请使用新账号登录。');
                document.getElementById('register-form-container').classList.add('hidden');
                document.getElementById('login-form-container').classList.remove('hidden');
                registerForm.reset();
            });
            
            logoutBtn.addEventListener('click', () => {
                if (confirm('确定要退出登录吗？')) {
                    currentUser = null;
                    localStorage.removeItem('currentUser');
                    showAuthPage();
                    loginForm.reset();
                }
            });
        }

        // ==================== 业务逻辑功能 ====================

        function canViewCustomer(customer) {
            if (!currentUser) return false;
            if (currentUser.role === 'admin') return true;
            return customer.createdBy === currentUser.id;
        }

        function checkDuplicateCustomer(email, phone, excludeId = null) {
            return customers.some(c => {
                if (excludeId && c.id === excludeId) return false;
                return c.email === email || (phone && c.phone === phone);
            });
        }

        // 页面导航
        function initNavigation() {
            const links = document.querySelectorAll('.sidebar-link');
            const pages = document.querySelectorAll('.page-content');
            
            links.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    links.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    const pageName = link.dataset.page;
                    pages.forEach(page => {
                        page.classList.toggle('hidden', page.id !== `${pageName}-page`);
                    });
                    
                    if (pageName === 'dashboard') updateDashboard();
                    else if (pageName === 'customers') renderCustomers();
                    else if (pageName === 'opportunities') { renderOpportunities(); updateOpportunityStats(); }
                    else if (pageName === 'interactions') renderInteractions();
                    else if (pageName === 'analytics') renderAnalytics();
                });
            });
        }

        // 仪表盘更新
        function updateDashboard() {
            let visibleCustomers = customers;
            if (currentUser && currentUser.role !== 'admin') {
                visibleCustomers = customers.filter(c => c.createdBy === currentUser.id);
            }
            
            const totalCustomers = visibleCustomers.length;
            const activeCustomers = visibleCustomers.filter(c => c.status === 'active').length;
            
            const visibleCustomerIds = visibleCustomers.map(c => c.id);
            const visibleInteractions = interactions.filter(i => visibleCustomerIds.includes(i.customerId));
            
            const now = new Date();
            const monthlyInteractions = visibleInteractions.filter(i => {
                const date = new Date(i.date);
                return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            }).length;
            
            const totalRevenue = visibleCustomers.reduce((sum, c) => sum + (c.value || 0), 0);
            
            animateNumber('total-customers', totalCustomers);
            animateNumber('active-customers', activeCustomers);
            animateNumber('monthly-interactions', monthlyInteractions);
            animateNumber('total-revenue', totalRevenue, true);
            
            renderCustomerGrowthChart();
            renderCustomerSourceChart();
        }

        function animateNumber(elementId, target, isCurrency = false) {
            const element = document.getElementById(elementId);
            if(!element) return;
            element.textContent = isCurrency ? `¥${target.toLocaleString()}` : target;
        }

        // 图表渲染 (使用 try-catch 防止图表库未加载导致崩溃)
        function renderCustomerGrowthChart() {
            try {
                const chartDom = document.getElementById('customer-growth-chart');
                if(!chartDom) return;
                const chart = echarts.init(chartDom);
                
                let visibleCustomers = customers;
                if (currentUser && currentUser.role !== 'admin') {
                    visibleCustomers = customers.filter(c => c.createdBy === currentUser.id);
                }
                
                const months = [];
                const data = [];
                const now = new Date();
                
                for (let i = 5; i >= 0; i--) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    months.push(`${date.getMonth() + 1}月`);
                    const count = visibleCustomers.filter(c => {
                        return new Date(c.createdAt) <= date;
                    }).length;
                    data.push(count);
                }
                
                const option = {
                    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                    xAxis: { type: 'category', data: months },
                    yAxis: { type: 'value' },
                    series: [{ data: data, type: 'line', smooth: true, itemStyle: { color: '#667eea' } }]
                };
                chart.setOption(option);
                window.addEventListener('resize', () => chart.resize());
            } catch(e) { console.error('Chart error:', e); }
        }

        function renderCustomerSourceChart() {
            try {
                const chartDom = document.getElementById('customer-source-chart');
                if(!chartDom) return;
                const chart = echarts.init(chartDom);
                
                let visibleCustomers = customers;
                if (currentUser && currentUser.role !== 'admin') {
                    visibleCustomers = customers.filter(c => c.createdBy === currentUser.id);
                }
                
                const sourceCount = {};
                visibleCustomers.forEach(c => sourceCount[c.source] = (sourceCount[c.source] || 0) + 1);
                
                const data = Object.keys(sourceCount).map(key => ({ name: key, value: sourceCount[key] }));
                
                const option = {
                    tooltip: { trigger: 'item' },
                    series: [{ type: 'pie', radius: ['40%', '70%'], data: data }]
                };
                chart.setOption(option);
                window.addEventListener('resize', () => chart.resize());
            } catch(e) { console.error('Chart error:', e); }
        }

        // 客户列表渲染
        function renderCustomers(filter = {}) {
            const tbody = document.getElementById('customers-table-body');
            if(!tbody) return;
            
            let filteredCustomers = [...customers];
            
            if (currentUser && currentUser.role !== 'admin') {
                filteredCustomers = filteredCustomers.filter(c => c.createdBy === currentUser.id);
            }
            
            if (filter.search) {
                const search = filter.search.toLowerCase();
                filteredCustomers = filteredCustomers.filter(c => 
                    c.name.toLowerCase().includes(search) || 
                    (c.company && c.company.toLowerCase().includes(search))
                );
            }
            if (filter.status) filteredCustomers = filteredCustomers.filter(c => c.status === filter.status);
            if (filter.source) filteredCustomers = filteredCustomers.filter(c => c.source === filter.source);
            
            tbody.innerHTML = filteredCustomers.map(customer => `
                <tr class="table-row">
                    <td class="px-6 py-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full bg-purple-500 flex items-center justify-center text-white font-semibold">
                                ${customer.name.charAt(0)}
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">${customer.name}</p>
                                <p class="text-sm text-gray-500">${customer.createdAt}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">${customer.company || '-'}</td>
                    <td class="px-6 py-4">
                        <p>${customer.email}</p>
                        <p class="text-sm text-gray-500">${customer.phone || '-'}</p>
                    </td>
                    <td class="px-6 py-4"><span class="px-2 py-1 bg-purple-100 text-purple-700 rounded">${customer.source}</span></td>
                    <td class="px-6 py-4"><span class="px-2 py-1 bg-green-100 text-green-700 rounded">${customer.status === 'active' ? '活跃' : '其他'}</span></td>
                    <td class="px-6 py-4">
                        <button onclick="editCustomer(${customer.id})" class="text-blue-600 mr-2"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteCustomer(${customer.id})" class="text-red-600"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        // 模态框与表单
        function initModals() {
            const customerModal = document.getElementById('customer-modal');
            const interactionModal = document.getElementById('interaction-modal');
            const opportunityModal = document.getElementById('opportunity-modal');
            
            // 绑定打开按钮
            document.getElementById('add-customer-btn')?.addEventListener('click', () => {
                currentEditId = null;
                currentEditType = 'customer';
                document.getElementById('customer-form').reset();
                customerModal.classList.add('active');
            });
            
            document.getElementById('add-interaction-btn')?.addEventListener('click', () => {
                updateInteractionCustomerSelect();
                document.getElementById('interaction-form').reset();
                interactionModal.classList.add('active');
            });
            
            document.getElementById('add-opportunity-btn')?.addEventListener('click', () => {
                currentEditId = null;
                currentEditType = 'opportunity';
                document.getElementById('opportunity-form').reset();
                opportunityModal.classList.add('active');
            });
            
            // 绑定关闭按钮
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    customerModal.classList.remove('active');
                    interactionModal.classList.remove('active');
                    opportunityModal.classList.remove('active');
                });
            });
        }

        function updateInteractionCustomerSelect() {
            const select = document.getElementById('interaction-customer');
            if(!select) return;
            select.innerHTML = '<option value="">请选择客户</option>' + 
                customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        function initCustomerForm() {
            const form = document.getElementById('customer-form');
            if(!form) return;
            
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const customerData = {
                    name: document.getElementById('customer-name').value,
                    company: document.getElementById('customer-company').value,
                    email: document.getElementById('customer-email').value,
                    phone: document.getElementById('customer-phone').value,
                    source: document.getElementById('customer-source').value,
                    status: document.getElementById('customer-status').value,
                    salesOwners: document.getElementById('customer-sales-owners').value,
                    interestedProducts: document.getElementById('customer-interested-products').value,
                    notes: document.getElementById('customer-notes').value,
                    value: 0
                };
                
                if (currentEditType === 'customer' && currentEditId) {
                    const index = customers.findIndex(c => c.id === currentEditId);
                    if (currentUser.role !== 'admin' && checkDuplicateCustomer(customerData.email, customerData.phone, currentEditId)) {
                        alert('客户已存在！'); return;
                    }
                    customers[index] = { ...customers[index], ...customerData };
                } else {
                    if (currentUser.role !== 'admin' && checkDuplicateCustomer(customerData.email, customerData.phone)) {
                        alert('客户已存在！'); return;
                    }
                    customerData.id = Date.now();
                    customerData.createdAt = new Date().toISOString().split('T')[0];
                    customerData.createdBy = currentUser.id;
                    customers.push(customerData);
                }
                saveData();
                renderCustomers();
                updateDashboard();
                document.getElementById('customer-modal').classList.remove('active');
                form.reset();
            });
        }

        function editCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (!customer) return;
            currentEditId = id;
            currentEditType = 'customer';
            document.getElementById('customer-name').value = customer.name;
            document.getElementById('customer-company').value = customer.company || '';
            document.getElementById('customer-email').value = customer.email;
            document.getElementById('customer-phone').value = customer.phone || '';
            document.getElementById('customer-source').value = customer.source;
            document.getElementById('customer-status').value = customer.status;
            document.getElementById('customer-sales-owners').value = customer.salesOwners || '';
            document.getElementById('customer-interested-products').value = customer.interestedProducts || '';
            document.getElementById('customer-notes').value = customer.notes || '';
            document.getElementById('customer-modal').classList.add('active');
        }

        function deleteCustomer(id) {
            if (confirm('确定删除?')) {
                customers = customers.filter(c => c.id !== id);
                interactions = interactions.filter(i => i.customerId !== id);
                saveData();
                renderCustomers();
                updateDashboard();
            }
        }
        
        // 绑定全局函数
        window.editCustomer = editCustomer;
        window.deleteCustomer = deleteCustomer;

        // 初始化入口
        window.onload = function() {
            initializeData();
            initAuthForms();
            
            if (currentUser) {
                initNavigation();
                initModals();
                initCustomerForm();
                // 其他初始化...
                updateDashboard();
                renderCustomers();
            }
        };
    </script>
```
    
</body>
</html>
```
