```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客户管理系统</title>
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.6.0/echarts.min.js"></script>
    <style>
        * {
            font-family: 'Noto Sans SC', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .status-badge {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .sidebar-link {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .sidebar-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .sidebar-link:hover::before,
        .sidebar-link.active::before {
            transform: scaleY(1);
        }
        
        .sidebar-link.active {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, transparent 100%);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            animation: slideUp 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .search-input {
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        .table-row {
            transition: all 0.2s ease;
        }
        
        .table-row:hover {
            background: rgba(102, 126, 234, 0.05);
            transform: scale(1.01);
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- 登录/注册页面 -->
    <div id="auth-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl p-8 max-w-md w-full shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto rounded-2xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center mb-4">
                    <i class="fas fa-users text-white text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">客户管理系统</h1>
                <p class="text-gray-500">CRM System</p>
            </div>
            
            <!-- 登录表单 -->
            <div id="login-form-container">
                <h2 class="text-xl font-bold text-gray-800 mb-6">登录账号</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">邮箱账号</label>
                        <input type="email" id="login-email" required 
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500"
                               placeholder="请输入企业邮箱 @fengfancloud.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">密码</label>
                        <input type="password" id="login-password" required 
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500"
                               placeholder="请输入密码">
                    </div>
                    <button type="submit" class="w-full btn-primary text-white px-6 py-3 rounded-xl font-medium shadow-lg">
                        登录
                    </button>
                </form>
                <p class="text-center text-gray-500 text-sm mt-4">
                    还没有账号？<a href="#" id="show-register" class="text-purple-600 hover:text-purple-700 font-medium">立即注册</a>
                </p>
            </div>
            
            <!-- 注册表单 -->
            <div id="register-form-container" class="hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-6">注册账号</h2>
                <form id="register-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">姓名</label>
                        <input type="text" id="register-name" required 
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500"
                               placeholder="请输入姓名">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">邮箱账号</label>
                        <input type="email" id="register-email" required 
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500"
                               placeholder="请输入企业邮箱 @fengfancloud.com">
                        <p class="text-xs text-gray-500 mt-1">仅支持公司企业邮箱注册</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">密码</label>
                        <input type="password" id="register-password" required minlength="6"
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500"
                               placeholder="至少6位密码">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">确认密码</label>
                        <input type="password" id="register-password-confirm" required minlength="6"
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500"
                               placeholder="再次输入密码">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">管理员注册码（选填）</label>
                        <input type="text" id="register-admin-code" 
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500"
                               placeholder="注册管理员请填写，普通用户留空">
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-3">
                        <p class="text-sm text-blue-700">
                            <i class="fas fa-info-circle mr-1"></i>
                            必须使用公司企业邮箱（@fengfancloud.com）注册，新用户默认为普通角色
                        </p>
                    </div>
                    <button type="submit" class="w-full btn-primary text-white px-6 py-3 rounded-xl font-medium shadow-lg">
                        注册
                    </button>
                </form>
                <p class="text-center text-gray-500 text-sm mt-4">
                    已有账号？<a href="#" id="show-login" class="text-purple-600 hover:text-purple-700 font-medium">立即登录</a>
                </p>
            </div>
        </div>
    </div>
    
    <!-- 主系统页面 -->
    <div id="main-system" class="flex h-screen overflow-hidden hidden">
        <!-- 侧边栏 -->
        <aside class="w-64 glass-effect shadow-xl flex flex-col">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center">
                        <i class="fas fa-users text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">客户管理系统</h1>
                        <p class="text-xs text-gray-500">CRM System</p>
                    </div>
                </div>
            </div>
            
            <nav class="flex-1 p-4 space-y-2">
                <a href="#" class="sidebar-link active flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="dashboard">
                    <i class="fas fa-chart-line w-5"></i>
                    <span class="font-medium">数据概览</span>
                </a>
                <a href="#" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="customers">
                    <i class="fas fa-users w-5"></i>
                    <span class="font-medium">客户列表</span>
                </a>
                <a href="#" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="opportunities">
                    <i class="fas fa-briefcase w-5"></i>
                    <span class="font-medium">商机管理</span>
                </a>
                <a href="#" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="interactions">
                    <i class="fas fa-comments w-5"></i>
                    <span class="font-medium">交互记录</span>
                </a>
                <a href="#" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700" data-page="analytics">
                    <i class="fas fa-chart-pie w-5"></i>
                    <span class="font-medium">数据分析</span>
                </a>
            </nav>
            
            <div class="p-4 border-t border-gray-200">
                <div class="px-4 py-3 space-y-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-orange-400 to-pink-500 flex items-center justify-center">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-800 truncate" id="current-user-name">用户</p>
                            <p class="text-xs text-gray-500 truncate" id="current-user-email">user@crm.com</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between px-2">
                        <span class="px-3 py-1 rounded-full text-xs font-medium" id="current-user-role-badge">
                            <i class="fas fa-user-shield mr-1"></i>管理员
                        </span>
                        <button id="logout-btn" class="text-gray-500 hover:text-red-600 transition" title="退出登录">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- 主内容区 -->
        <main class="flex-1 overflow-y-auto">
            <!-- 数据概览页面 -->
            <div id="dashboard-page" class="page-content p-8">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">数据概览</h2>
                    <p class="text-gray-500">实时监控您的客户数据和业务指标</p>
                </div>
                
                <!-- 统计卡片 -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="glass-effect rounded-2xl p-6 card-hover shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                                <i class="fas fa-users text-white text-xl"></i>
                            </div>
                            <span class="text-green-500 text-sm font-medium">
                                <i class="fas fa-arrow-up"></i> 12%
                            </span>
                        </div>
                        <h3 class="text-gray-500 text-sm font-medium mb-1">总客户数</h3>
                        <p class="text-3xl font-bold text-gray-800" id="total-customers">0</p>
                    </div>
                    
                    <div class="glass-effect rounded-2xl p-6 card-hover shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center">
                                <i class="fas fa-user-plus text-white text-xl"></i>
                            </div>
                            <span class="text-green-500 text-sm font-medium">
                                <i class="fas fa-arrow-up"></i> 5%
                            </span>
                        </div>
                        <h3 class="text-gray-500 text-sm font-medium mb-1">本月新增</h3>
                        <p class="text-3xl font-bold text-gray-800" id="new-customers">0</p>
                    </div>
                    
                    <div class="glass-effect rounded-2xl p-6 card-hover shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-400 to-pink-500 flex items-center justify-center">
                                <i class="fas fa-briefcase text-white text-xl"></i>
                            </div>
                            <span class="text-gray-400 text-sm font-medium">
                                持平
                            </span>
                        </div>
                        <h3 class="text-gray-500 text-sm font-medium mb-1">活跃商机</h3>
                        <p class="text-3xl font-bold text-gray-800" id="active-opportunities">0</p>
                    </div>
                    
                    <div class="glass-effect rounded-2xl p-6 card-hover shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-400 to-teal-500 flex items-center justify-center">
                                <i class="fas fa-money-bill-wave text-white text-xl"></i>
                            </div>
                            <span class="text-green-500 text-sm font-medium">
                                <i class="fas fa-arrow-up"></i> 8%
                            </span>
                        </div>
                        <h3 class="text-gray-500 text-sm font-medium mb-1">预计成交额</h3>
                        <p class="text-3xl font-bold text-gray-800" id="total-revenue">¥0</p>
                    </div>
                </div>
                
                <!-- 图表区域 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="glass-effect rounded-2xl p-6 shadow-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-6">客户增长趋势</h3>
                        <div id="customer-growth-chart" style="width: 100%; height: 300px;"></div>
                    </div>
                    <div class="glass-effect rounded-2xl p-6 shadow-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-6">商机转化漏斗</h3>
                        <div id="opportunity-funnel-chart" style="width: 100%; height: 300px;"></div>
                    </div>
                </div>
            </div>

            <!-- 客户列表页面 -->
            <div id="customers-page" class="page-content p-8 hidden">
                <div class="mb-8 flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">客户列表</h2>
                        <p class="text-gray-500">管理您的所有客户信息</p>
                    </div>
                    <button onclick="openCustomerModal()" class="btn-primary text-white px-6 py-3 rounded-xl font-medium shadow-lg flex items-center space-x-2">
                        <i class="fas fa-plus"></i>
                        <span>新增客户</span>
                    </button>
                </div>
                
                <!-- 筛选工具栏 -->
                <div class="glass-effect rounded-xl p-4 mb-6 flex flex-wrap gap-4 items-center justify-between">
                    <div class="flex items-center space-x-4 flex-1">
                        <div class="relative flex-1 max-w-md">
                            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="search-customer" class="search-input w-full pl-12 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-purple-500" placeholder="搜索客户姓名、公司或电话...">
                        </div>
                        <select id="filter-status" class="px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-purple-500 bg-white">
                            <option value="">所有状态</option>
                            <option value="潜在">潜在</option>
                            <option value="意向">意向</option>
                            <option value="成交">成交</option>
                            <option value="流失">流失</option>
                        </select>
                    </div>
                </div>
                
                <!-- 客户表格 -->
                <div class="glass-effect rounded-2xl overflow-hidden shadow-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-100">
                                <tr>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-600">客户信息</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-600">联系方式</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-600">状态</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-600">创建时间</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-600">操作</th>
                                </tr>
                            </thead>
                            <tbody id="customers-table-body" class="divide-y divide-gray-100">
                                <!-- 动态生成内容 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 商机管理页面 -->
            <div id="opportunities-page" class="page-content p-8 hidden">
                <div class="mb-8 flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">商机管理</h2>
                        <p class="text-gray-500">追踪销售机会与合同</p>
                    </div>
                    <button onclick="document.getElementById('opportunity-modal').classList.add('active')" class="btn-primary text-white px-6 py-3 rounded-xl font-medium shadow-lg flex items-center space-x-2">
                        <i class="fas fa-plus"></i>
                        <span>新增商机</span>
                    </button>
                </div>

                <!-- 商机统计栏 -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-gray-500 text-sm">商机总数</p>
                        <p class="text-2xl font-bold text-gray-800" id="total-opportunities">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-gray-500 text-sm">进行中</p>
                        <p class="text-2xl font-bold text-orange-500" id="ongoing-opportunities">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-gray-500 text-sm">已交付</p>
                        <p class="text-2xl font-bold text-green-500" id="delivered-opportunities">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-gray-500 text-sm">总金额</p>
                        <p class="text-2xl font-bold text-blue-600" id="total-opportunity-value">¥0</p>
                    </div>
                </div>
                
                <!-- 筛选工具栏 -->
                <div class="glass-effect rounded-xl p-4 mb-6 flex flex-wrap gap-4 items-center justify-between">
                    <div class="flex items-center space-x-4 flex-1">
                        <div class="relative flex-1 max-w-md">
                            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="search-opportunity" class="search-input w-full pl-12 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-purple-500" placeholder="搜索客户、公司或产品...">
                        </div>
                        <select id="filter-delivery" class="px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-purple-500 bg-white">
                            <option value="">全部状态</option>
                            <option value="false">进行中</option>
                            <option value="true">已交付</option>
                        </select>
                        <select id="filter-product" class="px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-purple-500 bg-white">
                            <option value="">全部产品</option>
                        </select>
                    </div>
                </div>

                <!-- 商机表格 -->
                <div class="glass-effect rounded-2xl overflow-hidden shadow-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-100">
                                <tr>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-600">客户信息</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-600">购买产品</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-600">原价</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-600">折扣</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-600">合同金额</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-600">交付状态</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-600">交付周期</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-600">账期</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-600">操作</th>
                                </tr>
                            </thead>
                            <tbody id="opportunities-table-body" class="divide-y divide-gray-100">
                                <!-- 动态生成内容 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 交互记录页面 -->
            <div id="interactions-page" class="page-content p-8 hidden">
                <div class="mb-8 flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">交互记录</h2>
                        <p class="text-gray-500">记录与客户的每一次沟通</p>
                    </div>
                    <button onclick="document.getElementById('interaction-modal').classList.add('active')" class="btn-primary text-white px-6 py-3 rounded-xl font-medium shadow-lg flex items-center space-x-2">
                        <i class="fas fa-plus"></i>
                        <span>新增记录</span>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6" id="interactions-list">
                        <!-- 动态生成记录 -->
                    </div>
                    
                    <div class="lg:col-span-1">
                        <div class="glass-effect rounded-2xl p-6 shadow-lg sticky top-8">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">最近跟进计划</h3>
                            <div class="space-y-4" id="follow-up-list">
                                <!-- 动态生成跟进计划 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 数据分析页面 -->
            <div id="analytics-page" class="page-content p-8 hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">数据分析</h2>
                    <p class="text-gray-500">深入了解您的客户数据和业务趋势</p>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="glass-effect rounded-2xl p-6 shadow-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-6">客户来源分布</h3>
                        <div id="analytics-source-chart" style="width: 100%; height: 350px;"></div>
                    </div>
                    <div class="glass-effect rounded-2xl p-6 shadow-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-6">客户行业分布</h3>
                        <div id="analytics-industry-chart" style="width: 100%; height: 350px;"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 客户模态框 -->
    <div id="customer-modal" class="modal">
        <div class="modal-content glass-effect rounded-2xl p-8 w-full max-w-2xl mx-4 shadow-2xl bg-white">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-gray-800" id="customer-modal-title">新增客户</h3>
                <button onclick="closeCustomerModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="customer-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">客户姓名</label>
                        <input type="text" id="customer-name" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">公司名称</label>
                        <input type="text" id="customer-company" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">联系电话</label>
                        <input type="tel" id="customer-phone" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">电子邮箱</label>
                        <input type="email" id="customer-email" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">所属行业</label>
                        <select id="customer-industry" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500 bg-white">
                            <option value="互联网/IT">互联网/IT</option>
                            <option value="金融">金融</option>
                            <option value="教育">教育</option>
                            <option value="制造">制造</option>
                            <option value="医疗">医疗</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">客户状态</label>
                        <select id="customer-status" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500 bg-white">
                            <option value="潜在">潜在客户</option>
                            <option value="意向">意向客户</option>
                            <option value="成交">成交客户</option>
                            <option value="流失">流失客户</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">备注信息</label>
                    <textarea id="customer-notes" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500"></textarea>
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" onclick="closeCustomerModal()" class="px-6 py-3 rounded-xl border border-gray-200 text-gray-600 hover:bg-gray-50 transition">取消</button>
                    <button type="submit" class="btn-primary text-white px-8 py-3 rounded-xl font-medium shadow-lg">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 交互记录模态框 -->
    <div id="interaction-modal" class="modal">
        <div class="modal-content glass-effect rounded-2xl p-8 w-full max-w-md mx-4 shadow-2xl bg-white">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-gray-800">新增交互记录</h3>
                <button onclick="document.getElementById('interaction-modal').classList.remove('active')" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="interaction-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">关联客户</label>
                    <select id="interaction-customer" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500 bg-white">
                        <!-- 动态生成选项 -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">交互方式</label>
                    <div class="grid grid-cols-3 gap-4">
                        <label class="cursor-pointer">
                            <input type="radio" name="interaction-type" value="电话" class="hidden peer" checked>
                            <div class="border border-gray-200 rounded-xl py-2 text-center peer-checked:bg-purple-50 peer-checked:border-purple-500 peer-checked:text-purple-600 transition">
                                <i class="fas fa-phone mb-1"></i>
                                <div class="text-xs">电话</div>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="interaction-type" value="会议" class="hidden peer">
                            <div class="border border-gray-200 rounded-xl py-2 text-center peer-checked:bg-purple-50 peer-checked:border-purple-500 peer-checked:text-purple-600 transition">
                                <i class="fas fa-users mb-1"></i>
                                <div class="text-xs">会议</div>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="interaction-type" value="邮件" class="hidden peer">
                            <div class="border border-gray-200 rounded-xl py-2 text-center peer-checked:bg-purple-50 peer-checked:border-purple-500 peer-checked:text-purple-600 transition">
                                <i class="fas fa-envelope mb-1"></i>
                                <div class="text-xs">邮件</div>
                            </div>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">沟通内容</label>
                    <textarea id="interaction-content" required rows="4" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="记录本次沟通的重点..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">下次跟进时间</label>
                    <input type="date" id="interaction-next-date" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500">
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" onclick="document.getElementById('interaction-modal').classList.remove('active')" class="px-6 py-3 rounded-xl border border-gray-200 text-gray-600 hover:bg-gray-50 transition">取消</button>
                    <button type="submit" class="btn-primary text-white px-8 py-3 rounded-xl font-medium shadow-lg">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 商机模态框 -->
    <div id="opportunity-modal" class="modal">
        <div class="modal-content glass-effect rounded-2xl p-8 w-full max-w-2xl mx-4 shadow-2xl bg-white max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-gray-800" id="opportunity-modal-title">新增商机</h3>
                <button onclick="document.getElementById('opportunity-modal').classList.remove('active')" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="opportunity-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">客户姓名</label>
                        <input type="text" id="opportunity-customer-name" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">公司名称</label>
                        <input type="text" id="opportunity-company" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">联系邮箱</label>
                        <input type="email" id="opportunity-email" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">联系电话</label>
                        <input type="tel" id="opportunity-phone" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">购买产品</label>
                        <input type="text" id="opportunity-product" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="例如：CRM系统专业版">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">原价 (¥)</label>
                        <input type="number" id="opportunity-original-price" required min="0" step="0.01" class="w-full px-4 py-3 border border-gray-floor(start + (target - start) * ease);
        
        if (isCurrency) {
            element.textContent = '¥' + current.toLocaleString();
        } else {
            element.textContent = current.toLocaleString();
        }
        
        if (progress < 1) {
            requestAnimationFrame(update);
        }
    }
    
    requestAnimationFrame(update);
}

// 渲染图表
function renderCharts(data) {
    // 客户增长趋势图
    const growthChart = echarts.init(document.getElementById('customer-growth-chart'));
    const dates = [...new Set(data.map(c => c.createdAt))].sort();
    const counts = dates.map(date => data.filter(c => c.createdAt <= date).length);
    
    growthChart.setOption({
        tooltip: { trigger: 'axis' },
        grid: { top: '10%', right: '5%', bottom: '10%', left: '5%', containLabel: true },
        xAxis: { type: 'category', data: dates },
        yAxis: { type: 'value' },
        series: [{
            data: counts,
            type: 'line',
            smooth: true,
            areaStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: 'rgba(102, 126, 234, 0.5)' },
                    { offset: 1, color: 'rgba(102, 126, 234, 0.0)' }
                ])
            },
            itemStyle: { color: '#667eea' }
        }]
    });
    
    // 商机漏斗图
    const funnelChart = echarts.init(document.getElementById('opportunity-funnel-chart'));
    const statusCounts = {
        '潜在': data.filter(c => c.status === '潜在').length,
        '意向': data.filter(c => c.status === '意向').length,
        '成交': data.filter(c => c.status === '成交').length
    };
    
    funnelChart.setOption({
        tooltip: { trigger: 'item' },
        series: [{
            type: 'funnel',
            left: '10%',
            top: 60,
            bottom: 60,
            width: '80%',
            min: 0,
            max: Math.max(...Object.values(statusCounts), 10),
            minSize: '0%',
            maxSize: '100%',
            sort: 'descending',
            gap: 2,
            label: { show: true, position: 'inside' },
            data: [
                { value: statusCounts['潜在'], name: '潜在客户' },
                { value: statusCounts['意向'], name: '意向客户' },
                { value: statusCounts['成交'], name: '成交客户' }
            ]
        }]
    });
    
    // 监听窗口大小变化
    window.addEventListener('resize', () => {
        growthChart.resize();
        funnelChart.resize();
    });
}

// 模态框控制
function initModals() {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        });
    });
}

function openCustomerModal(editMode = false) {
    const modal = document.getElementById('customer-modal');
    const title = document.getElementById('customer-modal-title');
    const form = document.getElementById('customer-form');
    
    if (editMode) {
        title.textContent = '编辑客户';
        currentEditType = 'customer';
    } else {
        title.textContent = '新增客户';
        form.reset();
        currentEditId = null;
        currentEditType = null;
    }
    
    modal.classList.add('active');
}

function closeCustomerModal() {
    document.getElementById('customer-modal').classList.remove('active');
}

// 初始化客户表单
function initCustomerForm() {
    const form = document.getElementById('customer-form');
    
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const customerData = {
            name: document.getElementById('customer-name').value,
            company: document.getElementById('customer-company').value,
            phone: document.getElementById('customer-phone').value,
            email: document.getElementById('customer-email').value,
            industry: document.getElementById('customer-industry').value,
            status: document.getElementById('customer-status').value,
            notes: document.getElementById('customer-notes').value
        };
        
        if (currentEditType === 'customer' && currentEditId) {
            // 编辑现有客户
            const index = customers.findIndex(c => c.id === currentEditId);
            customers[index] = { ...customers[index], ...customerData };
        } else {
            // 添加新客户
            customerData.id = Date.now();
            customerData.createdAt = new Date().toISOString().split('T')[0];
            customerData.createdBy = currentUser.id;
            customers.push(customerData);
        }
        
        saveData();
        renderCustomers();
        updateDashboard();
        closeCustomerModal();
    });
}

// 渲染客户列表
function renderCustomers(filter = {}) {
    const tbody = document.getElementById('customers-table-body');
    let displayCustomers = customers;
    
    // 权限过滤
    if (currentUser && currentUser.role !== 'admin') {
        displayCustomers = customers.filter(c => c.createdBy === currentUser.id);
    }
    
    // 搜索过滤
    if (filter.search) {
        const search = filter.search.toLowerCase();
        displayCustomers = displayCustomers.filter(c => 
            c.name.toLowerCase().includes(search) || 
            c.company.toLowerCase().includes(search) ||
            c.phone.includes(search)
        );
    }
    
    // 状态过滤
    if (filter.status) {
        displayCustomers = displayCustomers.filter(c => c.status === filter.status);
    }
    
    tbody.innerHTML = displayCustomers.map(customer => {
        const statusColors = {
            '潜在': 'bg-gray-100 text-gray-700',
            '意向': 'bg-blue-100 text-blue-700',
            '成交': 'bg-green-100 text-green-700',
            '流失': 'bg-red-100 text-red-700'
        };
        
        return `
            <tr class="table-row">
                <td class="px-6 py-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-indigo-500 flex items-center justify-center text-white font-semibold">
                            ${customer.name.charAt(0)}
                        </div>
                        <div>
                            <p class="font-medium text-gray-800">${customer.name}</p>
                            <p class="text-sm text-gray-500">${customer.company}</p>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <p class="text-gray-700"><i class="fas fa-phone-alt text-gray-400 mr-2"></i>${customer.phone}</p>
                    ${customer.email ? `<p class="text-gray-500 text-sm mt-1"><i class="fas fa-envelope text-gray-400 mr-2"></i>${customer.email}</p>` : ''}
                </td>
                <td class="px-6 py-4">
                    <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColors[customer.status] || 'bg-gray-100'}">
                        ${customer.status}
                    </span>
                </td>
                <td class="px-6 py-4 text-gray-500 text-sm">
                    ${customer.createdAt}
                </td>
                <td class="px-6 py-4">
                    <div class="flex space-x-2">
                        <button onclick="editCustomer(${customer.id})" class="text-blue-600 hover:text-blue-800 transition">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteCustomer(${customer.id})" class="text-red-600 hover:text-red-800 transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    // 更新交互表单中的客户选项
    updateCustomerSelect();
}

// 编辑客户
function editCustomer(id) {
    const customer = customers.find(c => c.id === id);
    if (!customer) return;
    
    currentEditId = id;
    document.getElementById('customer-name').value = customer.name;
    document.getElementById('customer-company').value = customer.company;
    document.getElementById('customer-phone').value = customer.phone;
    document.getElementById('customer-email').value = customer.email || '';
    document.getElementById('customer-industry').value = customer.industry || '其他';
    document.getElementById('customer-status').value = customer.status;
    document.getElementById('customer-notes').value = customer.notes || '';
    
    openCustomerModal(true);
}

// 删除客户
function deleteCustomer(id) {
    if (confirm('确定要删除这个客户吗？')) {
        customers = customers.filter(c => c.id !== id);
        saveData();
        renderCustomers();
        updateDashboard();
    }
}

// 更新客户选择下拉框
function updateCustomerSelect() {
    const selects = ['interaction-customer']; // 可以添加更多需要客户列表的select id
    
    selects.forEach(id => {
        const select = document.getElementById(id);
        if (select) {
            let options = customers;
            if (currentUser && currentUser.role !== 'admin') {
                options = customers.filter(c => c.createdBy === currentUser.id);
            }
            select.innerHTML = '<option value="">请选择客户</option>' + 
                options.map(c => `<option value="${c.id}">${c.name} - ${c.company}</option>`).join('');
        }
    });
}

// 初始化交互记录表单
function initInteractionForm() {
    const form = document.getElementById('interaction-form');
    
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const interactionData = {
            id: Date.now(),
            customerId: parseInt(document.getElementById('interaction-customer').value),
            type: document.querySelector('input[name="interaction-type"]:checked').value,
            content: document.getElementById('interaction-content').value,
            nextDate: document.getElementById('interaction-next-date').value,
            date: new Date().toISOString().split('T')[0]
        };
        
        interactions.push(interactionData);
        saveData();
        renderInteractions();
        
        document.getElementById('interaction-modal').classList.remove('active');
        form.reset();
    });
}

// 渲染交互记录
function renderInteractions() {
    const list = document.getElementById('interactions-list');
    const followUpList = document.getElementById('follow-up-list');
    
    // 过滤当前用户的客户交互
    let displayInteractions = interactions;
    if (currentUser && currentUser.role !== 'admin') {
        const userCustomerIds = customers.filter(c => c.createdBy === currentUser.id).map(c => c.id);
        displayInteractions = interactions.filter(i => userCustomerIds.includes(i.customerId));
    }
    
    // 渲染主列表
    list.innerHTML = displayInteractions.sort((a, b) => new Date(b.date) - new Date(a.date)).map(interaction => {
        const customer = customers.find(c => c.id === interaction.customerId) || { name: '未知客户', company: '' };
        
        return `
            <div class="glass-effect rounded-2xl p-6 shadow-sm hover:shadow-md transition">
                <div class="flex items-start justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-xl">
                            <i class="fas ${getInteractionIcon(interaction.type)}"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800">${customer.name} <span class="text-sm font-normal text-gray-500 ml-2">${customer.company}</span></h4>
                            <p class="text-sm text-gray-500 mt-1">${interaction.date}</p>
                        </div>
                    </div>
                    <button onclick="deleteInteraction(${interaction.id})" class="text-gray-400 hover:text-red-500">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="mt-4 pl-16">
                    <p class="text-gray-700 bg-gray-50 p-4 rounded-xl">${interaction.content}</p>
                    ${interaction.nextDate ? `
                        <div class="mt-3 flex items-center text-sm text-orange-600">
                            <i class="fas fa-clock mr-2"></i>
                            下次跟进：${interaction.nextDate}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
    
    // 渲染跟进计划
    const today = new Date().toISOString().split('T')[0];
    const upcoming = displayInteractions
        .filter(i => i.nextDate && i.nextDate >= today)
        .sort((a, b) => new Date(a.nextDate) - new Date(b.nextDate));
        
    followUpList.innerHTML = upcoming.length ? upcoming.map(interaction => {
        const customer = customers.find(c => c.id === interaction.customerId) || { name: '未知客户' };
        return `
            <div class="flex items-center p-3 rounded-xl bg-orange-50 border border-orange-100">
                <div class="flex-1">
                    <p class="font-medium text-gray-800">${customer.name}</p>
                    <p class="text-xs text-orange-600 mt-1">${interaction.nextDate}</p>
                </div>
                <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-orange-500 shadow-sm">
                    <i class="fas ${getInteractionIcon(interaction.type)}"></i>
                </div>
            </div>
        `;
    }).join('') : '<p class="text-gray-500 text-center py-4">暂无待办事项</p>';
}

function getInteractionIcon(type) {
    switch(type) {
        case '电话': return 'fa-phone';
        case '会议': return 'fa-users';
        case '邮件': return 'fa-envelope';
        default: return 'fa-comment';
    }
}

// 删除交互记录
function deleteInteraction(id) {
    if (confirm('确定要删除这条记录吗？')) {
        interactions = interactions.filter(i => i.id !== id);
        saveData();
        renderInteractions();
    }
}

// 初始化筛选器
function initFilters() {
    const searchInput = document.getElementById('search-customer');
    const statusFilter = document.getElementById('filter-status');
    
    const applyFilters = () => {
        renderCustomers({
            search: searchInput.value,
            status: statusFilter.value
        });
    };
    
    searchInput.addEventListener('input', applyFilters);
    statusFilter.addEventListener('change', applyFilters);
}

// 渲染分析图表
function renderAnalytics() {
    // 客户来源分析
    const sourceChart = echarts.init(document.getElementById('analytics-source-chart'));
    sourceChart.setOption({
        tooltip: { trigger: 'item' },
        legend: { bottom: '5%', left: 'center' },
        series: [{
            name: '客户来源',
            type: 'pie',
            radius: ['40%', '70%'],
            avoidLabelOverlap: false,
            itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 },
            label: { show: false, position: 'center' },
            emphasis: { label: { show: true, fontSize: '20', fontWeight: 'bold' } },
            data: [
                { value: 1048, name: '搜索引擎' },
                { value: 735, name: '直接访问' },
                { value: 580, name: '邮件营销' },
                { value: 484, name: '联盟广告' },
                { value: 300, name: '视频广告' }
            ]
        }]
    });
    
    // 行业分布分析
    const industryChart = echarts.init(document.getElementById('analytics-industry-chart'));
    const industryData = {};
    customers.forEach(c => {
        industryData[c.industry] = (industryData[c.industry] || 0) + 1;
    });
    
    industryChart.setOption({
        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
        xAxis: { type: 'category', data: Object.keys(industryData) },
        yAxis: { type: 'value' },
        series: [{
            data: Object.values(industryData),
            type: 'bar',
            itemStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: '#83bff6' },
                    { offset: 0.5, color: '#188df0' },
                    { offset: 1, color: '#188df0' }
                ])
            }
        }]
    });
    
    window.addEventListener('resize', () => {
        sourceChart.resize();
        industryChart.resize();
    });
}

// ==================== 商机管理功能 ====================

// 更新商机统计
function updateOpportunityStats() {
    const totalOpps = opportunities.length;
    const ongoingOpps = opportunities.filter(o => !o.isDelivered).length;
    const deliveredOpps = opportunities.filter(o => o.isDelivered).length;
    const totalValue = opportunities.reduce((sum, o) => sum + (o.amount || 0), 0);
    
    animateNumber('total-opportunities', totalOpps);
    animateNumber('ongoing-opportunities', ongoingOpps);
    animateNumber('delivered-opportunities', deliveredOpps);
    animateNumber('total-opportunity-value', totalValue, true);
}

// 渲染商机列表
function renderOpportunities(filter = {}) {
    const tbody = document.getElementById('opportunities-table-body');
    let filteredOpportunities = [...opportunities];
    
    // 应用搜索过滤
    if (filter.search) {
        const search = filter.search.toLowerCase();
        filteredOpportunities = filteredOpportunities.filter(o => 
            o.customerName.toLowerCase().includes(search) || 
            (o.company && o.company.toLowerCase().includes(search)) ||
            (o.product && o.product.toLowerCase().includes(search))
        );
    }
    
    // 应用交付状态过滤
    if (filter.delivery !== undefined && filter.delivery !== '') {
        const isDelivered = filter.delivery === 'true';
        filteredOpportunities = filteredOpportunities.filter(o => o.isDelivered === isDelivered);
    }
    
    // 应用产品过滤
    if (filter.product) {
        filteredOpportunities = filteredOpportunities.filter(o => o.product === filter.product);
    }
    
    tbody.innerHTML = filteredOpportunities.map(opp => {
        const deliveryStatus = opp.isDelivered 
            ? '<span class="px-3 py-1 rounded-full text-sm bg-green-100 text-green-700"><i class="fas fa-check-circle mr-1"></i>已交付</span>'
            : '<span class="px-3 py-1 rounded-full text-sm bg-orange-100 text-orange-700"><i class="fas fa-clock mr-1"></i>进行中</span>';
        
        return `
            <tr class="table-row">
                <td class="px-6 py-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-indigo-500 flex items-center justify-center text-white font-semibold">
                            ${opp.customerName.charAt(0)}
                        </div>
                        <div>
                            <p class="font-medium text-gray-800">${opp.customerName}</p>
                            <p class="text-sm text-gray-500">${opp.company}</p>
                            <p class="text-xs text-gray-400">${opp.email}</p>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <span class="px-3 py-1 rounded-full text-sm bg-purple-100 text-purple-700">
                        ${opp.product}
                    </span>
                </td>
                <td class="px-6 py-4">
                    <p class="text-gray-700">¥${(opp.originalPrice || opp.amount).toLocaleString()}</p>
                </td>
                <td class="px-6 py-4">
                    ${opp.discount && opp.discount > 0 
                        ? `<span class="px-2 py-1 rounded-lg text-sm bg-red-100 text-red-700 font-medium">${opp.discount}%</span>`
                        : '<span class="text-gray-400 text-sm">无折扣</span>'}
                </td>
                <td class="px-6 py-4">
                    <p class="font-semibold text-gray-800">¥${opp.amount.toLocaleString()}</p>
                    ${opp.discount && opp.discount > 0 
                        ? `<p class="text-xs text-green-600">已优惠 ¥${((opp.originalPrice || opp.amount) - opp.amount).toLocaleString()}</p>`
                        : ''}
                </td>
                <td class="px-6 py-4">
                    ${deliveryStatus}
                </td>
                <td class="px-6 py-4 text-gray-700">
                    ${opp.deliveryPeriod} 天
                </td>
                <td class="px-6 py-4 text-gray-700">
                    ${opp.paymentPeriod} 天
                </td>
                <td class="px-6 py-4">
                    <div class="flex space-x-2">
                        <button onclick="editOpportunity(${opp.id})" 
                                class="text-blue-600 hover:text-blue-800 transition"
                                title="编辑">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteOpportunity(${opp.id})" 
                                class="text-red-600 hover:text-red-800 transition"
                                title="删除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    // 更新产品筛选下拉框
    updateProductFilter();
}

// 更新产品筛选选项
function updateProductFilter() {
    const productFilter = document.getElementById('filter-product');
    const products = [...new Set(opportunities.map(o => o.product))];
    
    productFilter.innerHTML = '<option value="">全部产品</option>' + 
        products.map(p => `<option value="${p}">${p}</option>`).join('');
}

// 商机筛选初始化
function initOpportunityFilters() {
    const searchInput = document.getElementById('search-opportunity');
    const deliveryFilter = document.getElementById('filter-delivery');
    const productFilter = document.getElementById('filter-product');
    
    const applyFilters = () => {
        renderOpportunities({
            search: searchInput.value,
            delivery: deliveryFilter.value,
            product: productFilter.value
        });
    };
    
    searchInput.addEventListener('input', applyFilters);
    deliveryFilter.addEventListener('change', applyFilters);
    productFilter.addEventListener('change', applyFilters);
}

// 初始化商机表单
function initOpportunityForm() {
    const form = document.getElementById('opportunity-form');
    const originalPriceInput = document.getElementById('opportunity-original-price');
    const discountInput = document.getElementById('opportunity-discount');
    const amountInput = document.getElementById('opportunity-amount');
    
    // 自动计算合同金额
    function calculateAmount() {
        const originalPrice = parseFloat(originalPriceInput.value) || 0;
        const discount = parseFloat(discountInput.value) || 0;
        const amount = originalPrice * (1 - discount / 100);
        amountInput.value = amount.toFixed(2);
    }
    
    originalPriceInput.addEventListener('input', calculateAmount);
    discountInput.addEventListener('input', calculateAmount);
    
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const originalPrice = parseFloat(document.getElementById('opportunity-original-price').value);
        const discount = parseFloat(document.getElementById('opportunity-discount').value) || 0;
        
        const opportunityData = {
            customerName: document.getElementById('opportunity-customer-name').value,
            company: document.getElementById('opportunity-company').value,
            email: document.getElementById('opportunity-email').value,
            phone: document.getElementById('opportunity-phone').value,
            product: document.getElementById('opportunity-product').value,
            originalPrice: originalPrice,
            discount: discount,
            amount: parseFloat(document.getElementById('opportunity-amount').value),
            deliveryPeriod: parseInt(document.getElementById('opportunity-delivery-period').value),
            paymentPeriod: parseInt(document.getElementById('opportunity-payment-period').value),
            isDelivered: document.querySelector('input[name="delivery-status"]:checked').value === 'true',
            notes: document.getElementById('opportunity-notes').value
        };
        
        if (currentEditType === 'opportunity' && currentEditId) {
            // 编辑现有商机
            const index = opportunities.findIndex(o => o.id === currentEditId);
            opportunities[index] = { ...opportunities[index], ...opportunityData };
        } else {
            // 添加新商机
            opportunityData.id = Date.now();
            opportunityData.createdAt = new Date().toISOString().split('T')[0];
            opportunities.push(opportunityData);
        }
        
        saveData();
        renderOpportunities();
        updateOpportunityStats();
        document.getElementById('opportunity-modal').classList.remove('active');
        form.reset();
        currentEditId = null;
        currentEditType = null;
    });
}

// 编辑商机
function editOpportunity(id) {
    const opportunity = opportunities.find(o => o.id === id);
    if (!opportunity) return;
    
    currentEditId = id;
    currentEditType = 'opportunity';
    document.getElementById('opportunity-modal-title').textContent = '编辑商机';
    document.getElementById('opportunity-customer-name').value = opportunity.customerName;
    document.getElementById('opportunity-company').value = opportunity.company;
    document.getElementById('opportunity-email').value = opportunity.email;
    document.getElementById('opportunity-phone').value = opportunity.phone;
    document.getElementById('opportunity-product').value = opportunity.product;
    document.getElementById('opportunity-original-price').value = opportunity.originalPrice || opportunity.amount;
    document.getElementById('opportunity-discount').value = opportunity.discount || 0;
    document.getElementById('opportunity-amount').value = opportunity.amount;
    document.getElementById('opportunity-delivery-period').value = opportunity.deliveryPeriod;
    document.getElementById('opportunity-payment-period').value = opportunity.paymentPeriod;
    document.getElementById('opportunity-notes').value = opportunity.notes || '';
    
    // 设置交付状态
    const deliveryStatus = opportunity.isDelivered ? 'true' : 'false';
    document.querySelector(`input[name="delivery-status"][value="${deliveryStatus}"]`).checked = true;
    
    document.getElementById('opportunity-modal').classList.add('active');
}

// 删除商机
function deleteOpportunity(id) {
    if (confirm('确定要删除这个商机吗？')) {
        opportunities = opportunities.filter(o => o.id !== id);
        saveData();
        renderOpportunities();
        updateOpportunityStats();
    }
}

// 页面加载完成后初始化
window.onload = function() {
    // 1. 初始化数据
    initializeData();
    
    // 2. 初始化所有事件监听（无论登录状态，只绑定一次）
    // 这一点至关重要：必须在页面加载时绑定点击事件，否则登录后导航会失效
    initNavigation();
    initModals();
    initCustomerForm();
    initInteractionForm();
    initOpportunityForm();
    initFilters();
    initOpportunityFilters();
    initAuthForms();
    
    // 3. 初始数据渲染（如果已登录）
    if (currentUser) {
        updateDashboard();
        renderCustomers();
    }
};

// 导出函数供HTML调用
window.editCustomer = editCustomer;
window.deleteCustomer = deleteCustomer;
window.deleteInteraction = deleteInteraction;
window.editOpportunity = editOpportunity;
window.deleteOpportunity = deleteOpportunity;

    </script>
</body>
</html>
```
