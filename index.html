```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客户管理系统</title>
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.6.0/echarts.min.js"></script>
    <style>
        * { font-family: 'Noto Sans SC', sans-serif; }
        body { background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%); }
        .glass-effect { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s ease; }
        .btn-primary:hover { transform: scale(1.05); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4); }
        .sidebar-link { transition: all 0.3s ease; position: relative; overflow: hidden; }
        .sidebar-link::before { content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 3px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transform: scaleY(0); transition: transform 0.3s ease; }
        .sidebar-link:hover::before, .sidebar-link.active::before { transform: scaleY(1); }
        .sidebar-link.active { background: linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, transparent 100%); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; animation: fadeIn 0.3s ease; }
        .modal.active { display: flex; justify-content: center; align-items: center; }
        .modal-content { animation: slideUp 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .search-input { transition: all 0.3s ease; }
        .search-input:focus { box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2); }
        .table-row { transition: all 0.2s ease; }
        .table-row:hover { background: rgba(102, 126, 234, 0.05); transform: scale(1.01); }
    </style>
</head>
<body class="min-h-screen">
    <!-- 登录/注册页面 -->
    <div id="auth-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl p-8 max-w-md w-full shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto rounded-2xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center mb-4">
                    <i class="fas fa-users text-white text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">客户管理系统</h1>
                <p class="text-gray-500">CRM System</p>
            </div>
            
            <!-- 登录表单 -->
            <div id="login-form-container">
                <h2 class="text-xl font-bold text-gray-800 mb-6">登录账号</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">邮箱账号</label>
                        <input type="email" id="login-email" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="请输入企业邮箱 @fengfancloud.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">密码</label>
                        <input type="password" id="login-password" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="请输入密码">
                    </div>
                    <button type="submit" class="w-full btn-primary text-white px-6 py-3 rounded-xl font-medium shadow-lg">登录</button>
                </form>
                <p class="text-center text-gray-500 text-sm mt-4">还没有账号？<a href="#" id="show-register" class="text-purple-600 hover:text-purple-700 font-medium">立即注册</a></p>
            </div>
            
            <!-- 注册表单 -->
            <div id="register-form-container" class="hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-6">注册账号</h2>
                <form id="register-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">姓名</label>
                        <input type="text" id="register-name" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="请输入姓名">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">邮箱账号</label>
                        <input type="email" id="register-email" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="请输入企业邮箱 @fengfancloud.com">
                        <p class="text-xs text-gray-500 mt-1">仅支持公司企业邮箱注册</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">密码</label>
                        <input type="password" id="register-password" required minlength="6" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="至少6位密码">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">确认密码</label>
                        <input type="password" id="register-password-confirm" required minlength="6" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="请再次输入密码">
                    </div>
                    <button type="submit" class="w-full btn-primary text-white px-6 py-3 rounded-xl font-medium shadow-lg">注册</button>
                </form>
                <p class="text-center text-gray-500 text-sm mt-4">已有账号？<a href="#" id="show-login" class="text-purple-600 hover:text-purple-700 font-medium">立即登录</a></p>
            </div>
        </div>
    </div>

    <!-- 主系统界面 -->
    <div id="main-system" class="hidden flex min-h-screen">
        <!-- 侧边栏 -->
        <div class="w-64 glass-effect border-r border-gray-200 flex flex-col fixed h-full z-10">
            <div class="p-8">
                <div class="flex items-center space-x-3 mb-8">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center shadow-lg">
                        <i class="fas fa-chart-pie text-white"></i>
                    </div>
                    <span class="text-xl font-bold text-gray-800">CRM系统</span>
                </div>
                <nav class="space-y-2">
                    <a href="#" id="nav-dashboard" class="sidebar-link active flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-600 hover:text-purple-600"><i class="fas fa-home w-6"></i><span>数据概览</span></a>
                    <a href="#" id="nav-customers" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-600 hover:text-purple-600"><i class="fas fa-users w-6"></i><span>客户列表</span></a>
                    <a href="#" id="nav-opportunities" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-600 hover:text-purple-600"><i class="fas fa-briefcase w-6"></i><span>商机管理</span></a>
                    <a href="#" id="nav-interactions" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-600 hover:text-purple-600"><i class="fas fa-comments w-6"></i><span>交互记录</span></a>
                    <a href="#" id="nav-analysis" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-600 hover:text-purple-600"><i class="fas fa-chart-line w-6"></i><span>数据分析</span></a>
                </nav>
            </div>
            <div class="mt-auto p-8 border-t border-gray-100">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center"><i class="fas fa-user text-gray-500"></i></div>
                    <div><p class="font-medium text-gray-800" id="user-name">未登录</p><p class="text-xs text-gray-500" id="user-role">游客</p></div>
                </div>
                <button id="logout-btn" class="w-full flex items-center justify-center space-x-2 px-4 py-2 border border-gray-200 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors"><i class="fas fa-sign-out-alt"></i><span>退出登录</span></button>
            </div>
        </div>

        <!-- 主内容区域 -->
        <div class="flex-1 ml-64 p-8">
            <div class="flex justify-between items-center mb-8">
                <div><h2 class="text-2xl font-bold text-gray-800" id="page-title">数据概览</h2><p class="text-gray-500 mt-1" id="current-date">2026年2月12日</p></div>
                <div class="flex items-center space-x-4">
                    <div class="relative"><i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i><input type="text" placeholder="全局搜索..." class="search-input pl-12 pr-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500 w-64"></div>
                    <button class="w-10 h-10 rounded-xl bg-white border border-gray-200 flex items-center justify-center text-gray-500 hover:text-purple-600 transition-colors relative"><i class="fas fa-bell"></i><span class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></span></button>
                </div>
            </div>

            <div id="content-area">
                <!-- 仪表盘内容 -->
                <div id="dashboard-view" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="glass-effect p-6 rounded-2xl card-hover">
                            <div class="flex justify-between items-start mb-4"><div><p class="text-gray-500 text-sm">总客户数</p><h3 class="text-3xl font-bold text-gray-800 mt-1" id="stat-total-customers">0</h3></div><div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center"><i class="fas fa-users text-blue-500"></i></div></div>
                            <div class="flex items-center text-sm text-green-500"><i class="fas fa-arrow-up mr-1"></i><span>较上月 +12%</span></div>
                        </div>
                        <div class="glass-effect p-6 rounded-2xl card-hover">
                            <div class="flex justify-between items-start mb-4"><div><p class="text-gray-500 text-sm">活跃客户</p><h3 class="text-3xl font-bold text-gray-800 mt-1" id="stat-active-customers">0</h3></div><div class="w-10 h-10 rounded-lg bg-green-50 flex items-center justify-center"><i class="fas fa-user-check text-green-500"></i></div></div>
                            <div class="flex items-center text-sm text-green-500"><i class="fas fa-arrow-up mr-1"></i><span>较上月 +5%</span></div>
                        </div>
                        <div class="glass-effect p-6 rounded-2xl card-hover">
                            <div class="flex justify-between items-start mb-4"><div><p class="text-gray-500 text-sm">本月交互</p><h3 class="text-3xl font-bold text-gray-800 mt-1" id="stat-interactions">0</h3></div><div class="w-10 h-10 rounded-lg bg-purple-50 flex items-center justify-center"><i class="fas fa-comments text-purple-500"></i></div></div>
                            <div class="flex items-center text-sm text-purple-500"><i class="fas fa-arrow-up mr-1"></i><span>较上月 +8%</span></div>
                        </div>
                        <div class="glass-effect p-6 rounded-2xl card-hover">
                            <div class="flex justify-between items-start mb-4"><div><p class="text-gray-500 text-sm">总成交额</p><h3 class="text-3xl font-bold text-gray-800 mt-1" id="stat-revenue">¥0</h3></div><div class="w-10 h-10 rounded-lg bg-orange-50 flex items-center justify-center"><i class="fas fa-yen-sign text-orange-500"></i></div></div>
                            <div class="flex items-center text-sm text-orange-500"><i class="fas fa-arrow-up mr-1"></i><span>较上月 +15%</span></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="glass-effect p-6 rounded-2xl col-span-2"><h3 class="text-lg font-bold text-gray-800 mb-4">客户增长趋势</h3><div id="chart-growth" style="height: 300px;"></div></div>
                        <div class="glass-effect p-6 rounded-2xl"><h3 class="text-lg font-bold text-gray-800 mb-4">客户来源分布</h3><div id="chart-source" style="height: 300px;"></div></div>
                    </div>
                </div>

                <!-- 客户列表视图 -->
                <div id="customers-view" class="hidden space-y-6">
                    <div class="glass-effect p-6 rounded-2xl">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex space-x-4">
                                <div class="relative"><i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i><input type="text" id="customer-search" placeholder="搜索客户..." class="search-input pl-12 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500"></div>
                                <select id="customer-filter-status" class="px-4 py-2 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500"><option value="all">所有状态</option><option value="active">活跃</option><option value="potential">潜在</option><option value="inactive">休眠</option></select>
                            </div>
                            <button id="add-customer-btn" class="btn-primary text-white px-6 py-2 rounded-xl font-medium shadow-lg flex items-center space-x-2"><i class="fas fa-plus"></i><span>添加客户</span></button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead><tr class="text-left border-b border-gray-100"><th class="pb-4 font-semibold text-gray-600 pl-4">客户名称</th><th class="pb py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">公司名称 *</label><input type="text" id="opportunity-company" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">联系邮箱 *</label><input type="email" id="opportunity-email" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">联系电话 *</label><input type="tel" id="opportunity-phone" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">产品名称 *</label><input type="text" id="opportunity-product" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="例如：企业管理软件"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">产品报价 (元) *</label><input type="number" id="opportunity-original-price" required min="0" step="0.01" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="0.00"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">折扣 (%)</label><input type="number" id="opportunity-discount" min="0" max="100" step="0.1" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="例如：10 表示9折" value="0"><p class="text-xs text-gray-500 mt-1">0表示无折扣，10表示9折，20表示8折</p></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">合同金额 (元) *</label><input type="number" id="opportunity-amount" required min="0" step="0.01" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500 bg-gray-50" placeholder="0.00" readonly><p class="text-xs text-gray-500 mt-1">根据报价和折扣自动计算</p></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">交付周期 (天) *</label><input type="number" id="opportunity-delivery-period" required min="1" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="例如：30"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">回款周期 (天) *</label><input type="number" id="opportunity-payment-period" required min="1" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="例如：60"></div>
                </div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">是否已交付</label><div class="flex items-center space-x-6"><label class="flex items-center cursor-pointer"><input type="radio" name="delivery-status" value="false" checked class="w-4 h-4 text-purple-600 focus:ring-purple-500"><span class="ml-2 text-gray-700">未交付</span></label><label class="flex items-center cursor-pointer"><input type="radio" name="delivery-status" value="true" class="w-4 h-4 text-purple-600 focus:ring-purple-500"><span class="ml-2 text-gray-700">已交付</span></label></div></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">备注</label><textarea id="opportunity-notes" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-purple-500" placeholder="商机相关说明..."></textarea></div>
                <div class="flex justify-end space-x-4 pt-4"><button type="button" class="close-modal px-6 py-3 border border-gray-300 rounded-xl text-gray-700 hover:bg-gray-50 font-medium">取消</button><button type="submit" class="btn-primary text-white px-6 py-3 rounded-xl font-medium shadow-lg">保存</button></div>
            </form>
        </div>
    </div>

    <!-- 核心逻辑 -->
    <script>
        // 数据存储
        let currentUser = null;
        let users = [];
        let customers = [];
        let interactions = [];
        let opportunities = [];
        let currentEditId = null;
        let currentEditType = null;
        
        const COMPANY_EMAIL_DOMAIN = '@fengfancloud.com';

        // 初始化
        function initializeData() {
            const savedUsers = localStorage.getItem('users');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            } else {
                users = [{ id: 1, name: '系统管理员', email: 'admin@fengfancloud.com', password: 'admin123', role: 'admin', createdAt: '2026-01-01' }];
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            const savedCurrentUser = localStorage.getItem('currentUser');
            if (savedCurrentUser) {
                currentUser = JSON.parse(savedCurrentUser);
                showMainSystem();
            } else {
                showAuthPage();
                return;
            }
            
            const savedCustomers = localStorage.getItem('customers');
            if (savedCustomers) customers = JSON.parse(savedCustomers);
            else {
                customers = [{
                    id: 1, name: '张明', company: '科技创新有限公司', email: 'zhangming@tech.com', phone: '13800138001',
                    source: '网站', status: 'active', salesOwners: '王经理、李主管', interestedProducts: '企业管理软件, CRM系统',
                    notes: '重要客户', createdAt: '2026-01-15', value: 150000, createdBy: 1
                }];
                saveData();
            }
            
            const savedInteractions = localStorage.getItem('interactions');
            if (savedInteractions) interactions = JSON.parse(savedInteractions);
            else { interactions = []; saveData(); }
            
            const savedOpportunities = localStorage.getItem('opportunities');
            if (savedOpportunities) opportunities = JSON.parse(savedOpportunities);
            else { opportunities = []; saveData(); }
        }

        function validateEmail(email) {
            if (!email) return false;
            return email.toLowerCase().endsWith(COMPANY_EMAIL_DOMAIN);
        }

        function login(email, password) {
            if (!validateEmail(email)) {
                alert('请使用公司企业邮箱（@fengfancloud.com）登录！');
                return false;
            }
            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMainSystem();
                return true;
            } else {
                alert('邮箱或密码错误！');
                return false;
            }
        }

        function register(name, email, password) {
            if (!validateEmail(email)) {
                alert('请使用公司企业邮箱（@fengfancloud.com）注册！');
                return false;
            }
            if (users.some(u => u.email === email)) {
                alert('该邮箱已被注册！');
                return false;
            }
            const newUser = {
                id: Date.now(),
                name: name,
                email: email,
                password: password,
                role: 'user',
                createdAt: new Date().toISOString().split('T')[0]
            };
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            alert('注册成功！请登录');
            toggleAuthMode();
            return true;
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showAuthPage();
        }

        function toggleAuthMode() {
            const loginContainer = document.getElementById('login-form-container');
            const registerContainer = document.getElementById('register-form-container');
            if (loginContainer.classList.contains('hidden')) {
                loginContainer.classList.remove('hidden');
                registerContainer.classList.add('hidden');
            } else {
                loginContainer.classList.add('hidden');
                registerContainer.classList.remove('hidden');
            }
        }

        function showAuthPage() {
            document.getElementById('auth-page').classList.remove('hidden');
            document.getElementById('main-system').classList.add('hidden');
        }

        function showMainSystem() {
            document.getElementById('auth-page').classList.add('hidden');
            document.getElementById('main-system').classList.remove('hidden');
            document.getElementById('main-system').classList.add('flex');
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = currentUser.role === 'admin' ? '管理员' : '普通用户';
            showPage('dashboard');
        }

        function checkCustomerDuplicate(email, phone, excludeId = null) {
            if (currentUser.role === 'admin') return false;
            return customers.some(customer => {
                if (excludeId && customer.id === excludeId) return false;
                if (email && customer.email && customer.email.toLowerCase() === email.toLowerCase()) return true;
                if (phone && customer.phone && customer.phone === phone) return true;
                return false;
            });
        }

        function getVisibleCustomers() {
            if (!currentUser) return [];
            if (currentUser.role === 'admin') return customers;
            return customers.filter(c => c.createdBy === currentUser.id);
        }

        function calculateStats() {
            const visibleCustomers = getVisibleCustomers();
            const totalCustomers = visibleCustomers.length;
            const activeCustomers = visibleCustomers.filter(c => c.status === 'active').length;
            
            const currentMonth = new Date().toISOString().slice(0, 7);
            const visibleCustomerIds = visibleCustomers.map(c => c.id);
            const monthInteractions = interactions.filter(i => 
                i.date.startsWith(currentMonth) && visibleCustomerIds.includes(i.customerId)
            ).length;
            
            let totalRevenue = 0;
            if (currentUser.role === 'admin') {
                totalRevenue = opportunities.reduce((sum, op) => sum + (op.isDelivered ? parseFloat(op.amount) : 0), 0);
            } else {
                const myCustomerNames = visibleCustomers.map(c => c.name);
                const myOpportunities = opportunities.filter(op => myCustomerNames.includes(op.customerName));
                totalRevenue = myOpportunities.reduce((sum, op) => sum + (op.isDelivered ? parseFloat(op.amount) : 0), 0);
            }
            
            document.getElementById('stat-total-customers').textContent = totalCustomers;
            document.getElementById('stat-active-customers').textContent = activeCustomers;
            document.getElementById('stat-interactions').textContent = monthInteractions;
            document.getElementById('stat-revenue').textContent = '¥' + totalRevenue.toLocaleString();
        }

        function saveData() {
            localStorage.setItem('customers', JSON.stringify(customers));
            localStorage.setItem('interactions', JSON.stringify(interactions));
            localStorage.setItem('opportunities', JSON.stringify(opportunities));
        }

        function showPage(pageId) {
            ['dashboard-view', 'customers-view', 'opportunities-view', 'interactions-view', 'analysis-view'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
                link.classList.remove('bg-purple-50');
                link.classList.remove('text-purple-600');
            });
            document.getElementById(pageId + '-view').classList.remove('hidden');
            const navLink = document.getElementById('nav-' + pageId);
            if (navLink) navLink.classList.add('active');
            
            const titles = { 'dashboard': '数据概览', 'customers': '客户列表', 'opportunities': '商机管理', 'interactions': '交互记录', 'analysis': '数据分析' };
            document.getElementById('page-title').textContent = titles[pageId];
            
            if (pageId === 'dashboard') { calculateStats(); initCharts(); }
            else if (pageId === 'customers') renderCustomerList();
            else if (pageId === 'opportunities') renderOpportunityList();
            else if (pageId === 'interactions') renderInteractionList();
            else if (pageId === 'analysis') initAnalysisCharts();
        }

        function renderCustomerList() {
            const tbody = document.getElementById('customer-list-body');
            tbody.innerHTML = '';
            const searchTerm = document.getElementById('customer-search').value.toLowerCase();
            const statusFilter = document.getElementById('customer-filter-status').value;
            let visibleCustomers = getVisibleCustomers();
            const filteredCustomers = visibleCustomers.filter(c => {
                const matchesSearch = c.name.toLowerCase().includes(searchTerm) || c.company.toLowerCase().includes(searchTerm);
                const matchesStatus = statusFilter === 'all' || c.status === statusFilter;
                return matchesSearch && matchesStatus;
            });
            document.getElementById('showing-count').textContent = filteredCustomers.length;
            
            const statusColors = { 'active': 'bg-green-100 text-green-800', 'potential': 'bg-blue-100 text-blue-800', 'inactive': 'bg-gray-100 text-gray-800' };
            const statusText = { 'active': '活跃', 'potential': '潜在', 'inactive': '休眠' };
            
            filteredCustomers.forEach(customer => {
                const tr = document.createElement('tr');
                tr.className = 'table-row border-b border-gray-50';
                let salesOwnersHtml = (customer.salesOwners || '').split(/[,，、]/).filter(s=>s.trim()).map(o => '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 mr-1 mb-1"><i class="fas fa-user-tie mr-1 text-[10px]"></i>' + o.trim() + '</span>').join('');
                let productsHtml = (customer.interestedProducts || '').split(/[,，、]/).filter(p=>p.trim()).map(p => '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 mr-1 mb-1">' + p.trim() + '</span>').join('');
                
                tr.innerHTML = `
                    <td class="py-4 pl-4"><div class="flex items-center"><div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-white font-bold text-sm">${customer.name.charAt(0)}</div><div class="ml-3"><p class="text-sm font-medium text-gray-900">${customer.name}</p><p class="text-xs text-gray-500">ID: ${customer.id}</p></div></div></td>
                    <td class="py-4"><p class="text-sm text-gray-900">${customer.company}</p></td>
                    <td class="py-4"><div class="text-sm text-gray-500"><p><i class="fas fa-envelope w-4"></i> ${customer.email}</p><p><i class="fas fa-phone w-4"></i> ${customer.phone}</p></div></td>
                    <td class="py-4"><div class="flex flex-wrap max-w-[150px]">${salesOwnersHtml || '<span class="text-gray-400 text-xs">-</span>'}</div></td>
                    <td class="py-4"><div class="flex flex-wrap max-w-[200px]">${productsHtml || '<span class="text-gray-400 text-xs">-</span>'}</div></td>
                    <td class="py-4"><span class="px-3 py-1 rounded-full text-xs font-medium ${statusColors[customer.status]}">${statusText[customer.status]}</span></td>
                    <td class="py-4 text-sm text-gray-500">${customer.createdAt}</td>
                    <td class="py-4 pr-4 text-right"><button onclick="editCustomer(${customer.id})" class="text-blue-600 hover:text-blue-800 mr-3"><i class="fas fa-edit"></i></button><button onclick="deleteCustomer(${customer.id})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash-alt"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderOpportunityList() {
            const tbody = document.getElementById('opportunity-list-body');
            tbody.innerHTML = '';
            const searchTerm = document.getElementById('opportunity-search').value.toLowerCase();
            const statusFilter = document.getElementById('opportunity-filter-status').value;
            let visibleOpportunities = opportunities;
            if (currentUser.role !== 'admin') {
                const myCustomerNames = getVisibleCustomers().map(c => c.name);
                visibleOpportunities = opportunities.filter(op => myCustomerNames.includes(op.customerName));
            }
            const filteredOpportunities = visibleOpportunities.filter(op => {
                const matchesSearch = op.customerName.toLowerCase().includes(searchTerm) || op.product.toLowerCase().includes(searchTerm);
                const matchesStatus = statusFilter === 'all' || String(op.isDelivered) === statusFilter;
                return matchesSearch && matchesStatus;
            });
            
            filteredOpportunities.forEach(op => {
                const tr = document.createElement('tr');
                tr.className = 'table-row border-b border-gray-50';
                const discountDisplay = op.discount > 0 ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 ml-2">' + op.discount + '折</span>' : '';
                tr.innerHTML = `
                    <td class="py-4 pl-4"><div><p class="text-sm font-medium text-gray-900">${op.customerName}</p><p class="text-xs text-gray-500">${op.company}</p></div></td>
                    <td class="py-4"><p class="text-sm text-gray-900">${op.product}</p></td>
                    <td class="py-4"><div><p class="text-sm text-gray-500 line-through">¥${parseFloat(op.originalPrice).toLocaleString()}</p>${discountDisplay}</div></td>
                    <td class="py-4"><p class="text-sm font-bold text-gray-900">¥${parseFloat(op.amount).toLocaleString()}</p></td>
                    <td class="py-4"><div class="text-xs text-gray-500"><p>交付: ${op.deliveryPeriod}天</p><p>回款: ${op.paymentPeriod}天</p></div></td>
                    <td class="py-4"><span class="px-3 py-1 rounded-full text-xs font-medium ${op.isDelivered ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${op.isDelivered ? '已交付' : '未交付'}</span></td>
                    <td class="py-4 pr-4 text-right"><button onclick="editOpportunity(${op.id})" class="text-blue-600 hover:text-blue-800 mr-3"><i class="fas fa-edit"></i></button><button onclick="deleteOpportunity(${op.id})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash-alt"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderInteractionList() {
            const listBody = document.getElementById('interaction-list-body');
            listBody.innerHTML = '';
            let visibleInteractions = interactions;
            if (currentUser.role !== 'admin') {
                const myCustomerIds = getVisibleCustomers().map(c => c.id);
                visibleInteractions = interactions.filter(i => myCustomerIds.includes(i.customerId));
            }
            const sortedInteractions = [...visibleInteractions].sort((a, b) => new Date(b.date) - new Date(a.date));
            const typeIcons = { '电话': 'fa-phone', '邮件': 'fa-envelope', '会议': 'fa-users', '拜访': 'fa-car' };
            sortedInteractions.forEach(interaction => {
                const div = document.createElement('div');
                div.className = 'glass-effect p-4 rounded-xl border-l-4 border-purple-500';
                div.innerHTML = `<div class="flex justify-between items-start mb-2"><div class="flex items-center space-x-2"><span class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600"><i class="fas ${typeIcons[interaction.type]} text-sm"></i></span><span class="font-medium text-gray-800">${interaction.type} - ${interaction.customerName}</span></div><span class="text-sm text-gray-500">${interaction.date}</span></div><p class="text-gray-600 text-sm pl-10">${interaction.content}</p>`;
                listBody.appendChild(div);
            });
        }

        function initCharts() {
            const growthChart = echarts.init(document.getElementById('chart-growth'));
            const growthOption = {
                animation: true, tooltip: { trigger: 'axis' },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'category', data: ['8月', '9月', '10月', '11月', '12月', '1月'], axisLine: { lineStyle: { color: '#9ca3af' } } },
                yAxis: { type: 'value', axisLine: { show: false }, axisTick: { show: false }, splitLine: { lineStyle: { color: '#f3f4f6' } } },
                series: [{ data: [5, 8, 12, 15, 20, 25], type: 'line', smooth: true, symbolSize: 8, itemStyle: { color: '#7c3aed' }, areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(124, 58, 237, 0.3)' }, { offset: 1, color: 'rgba(124, 58, 237, 0)' }]) } }]
            };
            growthChart.setOption(growthOption);

            const sourceChart = echarts.init(document.getElementById('chart-source'));
            const visibleCustomers = getVisibleCustomers();
            const sourceData = {};
            visibleCustomers.forEach(c => { sourceData[c.source] = (sourceData[c.source] || 0) + 1; });
            const pieData = Object.keys(sourceData).map(key => ({ name: key, value: sourceData[key] }));
            const sourceOption = {
                tooltip: { trigger: 'item' }, legend: { bottom: '0%', left: 'center' },
                series: [{ name: '客户来源', type: 'pie', radius: ['40%', '70%'], avoidLabelOverlap: false, itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 }, label: { show: false }, data: pieData.length > 0 ? pieData : [{name: '无数据', value: 0}] }]
            };
            sourceChart.setOption(sourceOption);
            window.addEventListener('resize', () => { growthChart.resize(); sourceChart.resize(); });
        }

        function initAnalysisCharts() {
            const statusChart = echarts.init(document.getElementById('chart-status-dist'));
            const visibleCustomers = getVisibleCustomers();
            const statusData = { 'active': 0, 'potential': 0, 'inactive': 0 };
            visibleCustomers.forEach(c => { if (statusData[c.status] !== undefined) statusData[c.status]++; });
            const statusOption = {
                title: { text: '客户状态分布', left: 'center' }, tooltip: { trigger: 'item' }, legend: { orient: 'vertical', left: 'left' },
                series: [{ name: '状态', type: 'pie', radius: '50%', data: [{ value: statusData.active, name: '活跃', itemStyle: { color: '#10b981' } }, { value: statusData.potential, name: '潜在', itemStyle: { color: '#3b82f6' } }, { value: statusData.inactive, name: '休眠', itemStyle: { color: '#9ca3af' } }], emphasis: { itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' } } }]
            };
            statusChart.setOption(statusOption);

            const trendChart = echarts.init(document.getElementById('chart-interaction-trend'));
            const trendOption = {
                title: { text: '近6个月交互次数', left: 'center' }, tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: [{ type: 'category', data: ['9月', '10月', '11月', '12月', '1月', '2月'], axisTick: { alignWithLabel: true } }],
                yAxis: [{ type: 'value' }],
                series: [{ name: '交互次数', type: 'bar', barWidth: '60%', data: [10, 52, 200, 334, 390, 330], itemStyle: { color: '#8b5cf6' } }]
            };
            trendChart.setOption(trendOption);
            window.addEventListener('resize', () => { statusChart.resize(); trendChart.resize(); });
        }

        function openModal(modalId) { document.getElementById(modalId).classList.add('active'); }
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            const formId = modalId.replace('-modal', '-form');
            document.getElementById(formId).reset();
            currentEditId = null;
            if (modalId === 'customer-modal') {
                const emailMsg = document.getElementById('email-check-msg'); if (emailMsg) { emailMsg.textContent = '将自动检查重复'; emailMsg.className = 'text-xs text-gray-500 mt-1'; }
                const phoneMsg = document.getElementById('phone-check-msg'); if (phoneMsg) { phoneMsg.textContent = '将自动检查重复'; phoneMsg.className = 'text-xs text-gray-500 mt-1'; }
            }
        }

        document.getElementById('add-customer-btn').addEventListener('click', () => { document.getElementById('modal-title').textContent = '添加新客户'; openModal('customer-modal'); });
        
        function setupDuplicateCheck() {
            const emailInput = document.getElementById('customer-email');
            const phoneInput = document.getElementById('customer-phone');
            const checkHandler = () => {
                if (currentUser.role === 'admin') return;
                const email = emailInput.value.trim();
                const phone = phoneInput.value.trim();
                if (email) {
                    const isDuplicate = checkCustomerDuplicate(email, null, currentEditId);
                    const msgEl = document.getElementById('email-check-msg');
                    if (isDuplicate) { msgEl.textContent = '❌ 该邮箱已存在！'; msgEl.className = 'text-xs text-red-500 mt-1 font-bold'; }
                    else { msgEl.textContent = '✅ 邮箱可用'; msgEl.className = 'text-xs text-green-500 mt-1'; }
                }
                if (phone) {
                    const isDuplicate = checkCustomerDuplicate(null, phone, currentEditId);
                    const msgEl = document.getElementById('phone-check-msg');
                    if (isDuplicate) { msgEl.textContent = '❌ 该电话已存在！'; msgEl.className = 'text-xs text-red-500 mt-1 font-bold'; }
                    else { msgEl.textContent = '✅ 电话可用'; msgEl.className = 'text-xs text-green-500 mt-1'; }
                }
            };
            emailInput.addEventListener('blur', checkHandler);
            phoneInput.addEventListener('blur', checkHandler);
        }

        document.getElementById('customer-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('customer-name').value;
            const company = document.getElementById('customer-company').value;
            const email = document.getElementById('customer-email').value;
            const phone = document.getElementById('customer-phone').value;
            const source = document.getElementById('customer-source').value;
            const status = document.getElementById('customer-status').value;
            const salesOwners = document.getElementById('customer-sales-owners').value;
            const interestedProducts = document.getElementById('customer-interested-products').value;
            const notes = document.getElementById('customer-notes').value;
            
            if (currentUser.role !== 'admin') {
                const isDuplicate = checkCustomerDuplicate(email, phone, currentEditId);
                if (isDuplicate) { alert('该客户已存在（邮箱或电话重复），无法添加！'); return; }
            }
            
            if (currentEditId) {
                const index = customers.findIndex(c => c.id === currentEditId);
                if (index !== -1) {
                    const originalCreatedBy = customers[index].createdBy;
                    const originalCreatedAt = customers[index].createdAt;
                    customers[index] = { id: currentEditId, name, company, email, phone, source, status, notes, salesOwners, interestedProducts, createdAt: originalCreatedAt, createdBy: originalCreatedBy, value: customers[index].value };
                }
            } else {
                const newCustomer = { id: Date.now(), name, company, email, phone, source, status, notes, salesOwners, interestedProducts, createdAt: new Date().toISOString().split('T')[0], value: 0, createdBy: currentUser.id };
                customers.push(newCustomer);
            }
            saveData(); closeModal('customer-modal'); renderCustomerList(); calculateStats();
        });

        function editCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (customer) {
                currentEditId = id; document.getElementById('modal-title').textContent = '编辑客户';
                document.getElementById('customer-name').value = customer.name;
                document.getElementById('customer-company').value = customer.company;
                document.getElementById('customer-email').value = customer.email;
                document.getElementById('customer-phone').value = customer.phone;
                document.getElementById('customer-source').value = customer.source;
                document.getElementById('customer-status').value = customer.status;
                document.getElementById('customer-sales-owners').value = customer.salesOwners || '';
                document.getElementById('customer-interested-products').value = customer.interestedProducts || '';
                document.getElementById('customer-notes').value = customer.notes || '';
                openModal('customer-modal');
            }
        }

        function deleteCustomer(id) {
            if (confirm('确定要删除这个客户吗？')) { customers = customers.filter(c => c.id !== id); saveData(); renderCustomerList(); calculateStats(); }
        }

        document.getElementById('add-opportunity-btn').addEventListener('click', () => { document.getElementById('opportunity-modal-title').textContent = '添加商机'; openModal('opportunity-modal'); });

        function setupPriceCalculation() {
            const originalPriceInput = document.getElementById('opportunity-original-price');
            const discountInput = document.getElementById('opportunity-discount');
            const amountInput = document.getElementById('opportunity-amount');
            const calculateAmount = () => {
                const originalPrice = parseFloat(originalPriceInput.value) || 0;
                const discount = parseFloat(discountInput.value) || 0;
                let finalAmount = originalPrice;
                if (discount > 0 && discount <= 100) finalAmount = originalPrice * (100 - discount) / 100;
                amountInput.value = finalAmount.toFixed(2);
            };
            originalPriceInput.addEventListener('input', calculateAmount);
            discountInput.addEventListener('input', calculateAmount);
        }

        document.getElementById('opportunity-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const customerName = document.getElementById('opportunity-customer-name').value;
            const company = document.getElementById('opportunity-company').value;
            const email = document.getElementById('opportunity-email').value;
            const phone = document.getElementById('opportunity-phone').value;
            const product = document.getElementById('opportunity-product').value;
            const originalPrice = parseFloat(document.getElementById('opportunity-original-price').value);
            const discount = parseFloat(document.getElementById('opportunity-discount').value) || 0;
            const amount = parseFloat(document.getElementById('opportunity-amount').value);
            const deliveryPeriod = parseInt(document.getElementById('opportunity-delivery-period').value);
            const paymentPeriod = parseInt(document.getElementById('opportunity-payment-period').value);
            const isDelivered = document.querySelector('input[name="delivery-status"]:checked').value === 'true';
            const notes = document.getElementById('opportunity-notes').value;
            
            if (currentEditId) {
                const index = opportunities.findIndex(o => o.id === currentEditId);
                if (index !== -1) {
                    opportunities[index] = { ...opportunities[index], customerName, company, email, phone, product, originalPrice, discount, amount, deliveryPeriod, paymentPeriod, isDelivered, notes };
                }
            } else {
                const newOpportunity = { id: Date.now(), customerName, company, email, phone, product, originalPrice, discount, amount, deliveryPeriod, paymentPeriod, isDelivered, notes, createdAt: new Date().toISOString().split('T')[0] };
                opportunities.push(newOpportunity);
            }
            saveData(); closeModal('opportunity-modal'); renderOpportunityList(); calculateStats();
        });

        function editOpportunity(id) {
            const op = opportunities.find(o => o.id === id);
            if (op) {
                currentEditId = id; document.getElementById('opportunity-modal-title').textContent = '编辑商机';
                document.getElementById('opportunity-customer-name').value = op.customerName;
                document.getElementById('opportunity-company').value = op.company;
                document.getElementById('opportunity-email').value = op.email;
                document.getElementById('opportunity-phone').value = op.phone;
                document.getElementById('opportunity-product').value = op.product;
                document.getElementById('opportunity-original-price').value = op.originalPrice;
                document.getElementById('opportunity-discount').value = op.discount;
                document.getElementById('opportunity-amount').value = op.amount;
                document.getElementById('opportunity-delivery-period').value = op.deliveryPeriod;
                document.getElementById('opportunity-payment-period').value = op.paymentPeriod;
                const radios = document.getElementsByName('delivery-status');
                for (let radio of radios) { if (radio.value === String(op.isDelivered)) { radio.checked = true; break; } }
                document.getElementById('opportunity-notes').value = op.notes || '';
                openModal('opportunity-modal');
            }
        }

        function deleteOpportunity(id) {
            if (confirm('确定要删除这个商机吗？')) { opportunities = opportunities.filter(o => o.id !== id); saveData(); renderOpportunityList(); calculateStats(); }
        }

        document.getElementById('add-interaction-btn').addEventListener('click', () => {
            const select = document.getElementById('interaction-customer');
            select.innerHTML = '<option value="">请选择客户</option>';
            const visibleCustomers = getVisibleCustomers();
            visibleCustomers.forEach(c => { const option = document.createElement('option'); option.value = c.id; option.textContent = c.name; select.appendChild(option); });
            openModal('interaction-modal');
        });

        document.getElementById('interaction-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const customerId = parseInt(document.getElementById('interaction-customer').value);
            const customer = customers.find(c => c.id === customerId);
            const type = document.getElementById('interaction-type').value;
            const content = document.getElementById('interaction-content').value;
            const newInteraction = { id: Date.now(), customerId, customerName: customer.name, type, content, date: new Date().toISOString().split('T')[0] };
            interactions.push(newInteraction); saveData(); closeModal('interaction-modal'); renderInteractionList(); calculateStats();
        });

        document.querySelectorAll('.close-modal').forEach(btn => { btn.addEventListener('click', function() { const modal = this.closest('.modal'); closeModal(modal.id); }); });
        window.onclick = function(event) { if (event.target.classList.contains('modal')) { closeModal(event.target.id); } };
        
        document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; login(email, password); });
        document.getElementById('register-form').addEventListener('submit', (e) => { e.preventDefault(); const name = document.getElementById('register-name').value; const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; const confirmPassword = document.getElementById('register-password-confirm').value; if (password !== confirmPassword) { alert('两次输入的密码不一致！'); return; } register(name, email, password); });
        
        document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); toggleAuthMode(); });
        document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); toggleAuthMode(); });
        document.getElementById('logout-btn').addEventListener('click', logout);
        
        document.querySelectorAll('.sidebar-link').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const pageId = e.currentTarget.id.replace('nav-', ''); showPage(pageId); }); });
        
        ['customer', 'opportunity'].forEach(type => {
            const searchInput = document.getElementById(type + '-search');
            if (searchInput) searchInput.addEventListener('input', () => { if (type === 'customer') renderCustomerList(); else renderOpportunityList(); });
            const filterSelect = document.getElementById(type + '-filter-status');
            if (filterSelect) filterSelect.addEventListener('change', () => { if (type === 'customer') renderCustomerList(); else renderOpportunityList(); });
        });

        document.addEventListener('DOMContentLoaded', () => { initializeData(); setupPriceCalculation(); setupDuplicateCheck(); });
    </script>
</body>
</html>
```
